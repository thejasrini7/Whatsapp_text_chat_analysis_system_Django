{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Group Events Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { background: #f6f8fb; }
    .card-metric { cursor: pointer; transition: transform .1s ease; }
    .card-metric:hover { transform: translateY(-2px); }
    .metric-value { font-size: 2rem; font-weight: 700; }
    .metric-label { color: #6c757d; font-size: .85rem; }
    .btn-analyze { background: #22c55e; color: white; }
    .btn-analyze:hover { background: #16a34a; color: white; }
    .icon-badge { width: 42px; height: 42px; display:flex; align-items:center; justify-content:center; border-radius: .5rem; }
    .form-section { background: white; border-radius: .75rem; padding: 1rem; box-shadow: 0 1rem 2rem rgba(0,0,0,.05); }
    .table-sticky thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-0">Group Events Analysis</h2>
        <small class="text-muted">Analyze member and admin actions over time</small>
      </div>
      <a class="btn btn-outline-secondary" href="/home"><i class="fa fa-arrow-left me-2"></i>Back</a>
    </div>

    <div id="dateBar" style="display: none; background: #fff; border: 1px solid #ddd; padding: 8px; text-align: center; margin-bottom: 16px; font-weight: 500; font-size: 14px;">
      Using chat data from <strong id="startDateText"></strong> to <strong id="endDateText"></strong>
    </div>
    <style>
      @media (max-width: 768px) {
        #dateBar {
          font-size: 12px;
          padding: 6px;
        }
      }
    </style>

    <!-- Input Section -->
    <div class="form-section mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Group</label>
          <select id="groupSelect" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Start Date</label>
          <input id="startDate" type="date" class="form-control">
          <div id="startDateHint" style="font-size: 0.9em; color: #666; margin-top: 5px; display: none;"></div>
        </div>
        <div class="col-md-2">
          <label class="form-label">End Date</label>
          <input id="endDate" type="date" class="form-control">
          <div id="endDateHint" style="font-size: 0.9em; color: #666; margin-top: 5px; display: none;"></div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Event Types</label>
          <select id="eventTypes" class="form-select" multiple>
            <option value="added">Added</option>
            <option value="left">Left</option>
            <option value="removed">Removed</option>
            <option value="changed_subject">Subject Changed</option>
            <option value="changed_icon">Icon Changed</option>
            <option value="created">Group Created</option>
          </select>
          <div class="form-text">Hold Ctrl/Cmd to multi-select</div>
        </div>
        <div class="col-md-2">
          <label class="form-label">User Filter</label>
          <input id="userFilter" class="form-control" placeholder="Admin/User name">
        </div>
        <div class="col-md-12 d-flex justify-content-end">
          <button id="analyzeBtn" class="btn btn-analyze"><i class="fa fa-chart-line me-2"></i>Analyze Events</button>
        </div>
      </div>
    </div>

    <!-- Event Summary Cards -->
    <div class="row g-3" id="cardsRow">
      <!-- Cards inserted by JS -->
    </div>

    <!-- Insights Row -->
    <div class="row g-3 mt-1">
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title mb-3"><i class="fa fa-lightbulb me-2"></i>Extra Insights</h6>
            <div id="insightsArea">
              <div class="d-flex justify-content-between"><span class="text-muted">Most Active Day</span><strong id="insMostDay">-</strong></div>
              <div class="d-flex justify-content-between mt-2"><span class="text-muted">Total Events</span><strong id="insTotal">0</strong></div>
              <div class="mt-3">
                <span class="text-muted d-block mb-1">Top Contributors</span>
                <ol class="mb-0" id="insContrib" style="padding-left: 1rem"></ol>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title mb-3"><i class="fa fa-chart-area me-2"></i>Events Over Time</h6>
            <canvas id="timeChart" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Distribution Chart -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title mb-3"><i class="fa fa-chart-pie me-2"></i>Event Distribution</h6>
            <canvas id="distChart" height="80"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drilldown Modal -->
  <div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logsTitle">Event Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-2">
            <div class="col-md-8">
              <input id="logsSearch" class="form-control" placeholder="Search in logs (type to filter)">
            </div>
            <div class="col-md-4 text-end">
              <small class="text-muted" id="logsCount"></small>
            </div>
          </div>
          <div class="table-responsive table-sticky" style="max-height: 60vh;">
            <table class="table table-sm table-hover align-middle" id="logsTable">
              <thead>
                <tr>
                  <th>Event Type</th>
                  <th>Actor</th>
                  <th>Target</th>
                  <th>Date & Time</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Utilities
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const ICONS = {
      added: 'fa-circle-plus',
      left: 'fa-door-open',
      removed: 'fa-trash',
      changed_subject: 'fa-pen-to-square',
      changed_icon: 'fa-image',
      created: 'fa-flag-checkered',
    };

    const COLORS = {
      added: '#22c55e',
      left: '#94a3b8',
      removed: '#ef4444',
      changed_subject: '#f59e0b',
      changed_icon: '#3b82f6',
      created: '#10b981',
    };

    let timeChart, distChart, cachedActors = [];
    let lastPayload = null; // to reuse for drilldowns

    function getSelectedEventTypes() {
      return Array.from($('#eventTypes').selectedOptions).map(o => o.value);
    }

    async function fetchJSON(url, body) {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      return res.json();
    }

    function cardTemplate(key, value) {
      const titles = {
        added: 'Added', left: 'Left', removed: 'Removed', changed_subject: 'Subject Changed', changed_icon: 'Icon Changed', created: 'Group Created'
      };
      const icon = ICONS[key] || 'fa-circle';
      const bg = `background: ${COLORS[key]}22; color: ${COLORS[key]}`;
      return `
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card card-metric" data-event="${key}">
            <div class="card-body d-flex align-items-center gap-3">
              <div class="icon-badge" style="${bg}"><i class="fa ${icon}"></i></div>
              <div>
                <div class="small text-muted">${titles[key]}</div>
                <div class="metric-value">${value}</div>
                <div class="metric-label">events</div>
              </div>
            </div>
          </div>
        </div>`;
    }

    function buildCards(counts) {
      const row = $('#cardsRow');
      row.innerHTML = '';
      ['added','left','removed','changed_subject','changed_icon','created'].forEach(k => {
        row.insertAdjacentHTML('beforeend', cardTemplate(k, counts[k] || 0));
      });
      // Click handlers for drilldown
      $$('#cardsRow .card-metric').forEach(card => {
        card.addEventListener('click', () => openLogsModal([card.dataset.event]));
      });
    }

    function renderInsights(insights) {
      $('#insMostDay').textContent = insights.most_active_day ? `${insights.most_active_day.date} (${insights.most_active_day.total})` : '-';
      $('#insTotal').textContent = insights.total_events || 0;
      const list = $('#insContrib');
      list.innerHTML = '';
      (insights.top_contributors || []).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name} — ${item.count}`;
        list.appendChild(li);
      });
    }

    function renderTimeSeries(timeseries) {
      const labels = timeseries.map(d => d.date);
      const datasets = ['added','left','removed','changed_subject','changed_icon','created'].map(key => ({
        label: key.replace('_',' '),
        data: timeseries.map(d => d[key] || 0),
        borderColor: COLORS[key],
        backgroundColor: COLORS[key],
        tension: .25,
        fill: false,
      }));
      if (timeChart) timeChart.destroy();
      timeChart = new Chart($('#timeChart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          interaction: { intersect: false, mode: 'index' },
          plugins: { tooltip: { enabled: true } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function renderDistribution(dist) {
      const labels = ['added','left','removed','changed_subject','changed_icon','created'];
      const data = labels.map(k => dist.counts?.[k] || 0);
      const bg = labels.map(k => COLORS[k] + 'AA');
      if (distChart) distChart.destroy();
      distChart = new Chart($('#distChart'), {
        type: 'doughnut',
        data: { labels: labels.map(l => l.replace('_',' ')), datasets: [{ data, backgroundColor: bg }] },
        options: { plugins: { tooltip: { enabled: true } } }
      });
    }

    async function analyze() {
      const payload = {
        group_name: $('#groupSelect').value,
        start_date: $('#startDate').value || null,
        end_date: $('#endDate').value || null,
        event_types: getSelectedEventTypes().length ? getSelectedEventTypes() : null,
        user: ($('#userFilter').value || '').trim() || null,
      };
      lastPayload = payload;
      const res = await fetchJSON('/api/group_events/analytics/', payload);
      if (res.error) { alert(res.error); return; }
      cachedActors = res.actors || [];
      buildCards(res.event_counts || {});
      renderInsights(res.insights || {});
      renderTimeSeries(res.timeseries || []);
      renderDistribution(res.distribution || { counts: {} });
    }

    async function openLogsModal(eventTypes) {
      if (!lastPayload) return;
      const payload = { ...lastPayload, event_types: eventTypes };
      const res = await fetchJSON('/api/group_events/logs/', payload);
      const rows = res.events || [];
      $('#logsTitle').textContent = `Event Logs — ${eventTypes.map(x=>x.replace('_',' ')).join(', ')}`;
      const tbody = $('#logsTable tbody');
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.event_type.replace('_',' ')}</td>
          <td>${r.actor || ''}</td>
          <td>${r.target || ''}</td>
          <td>${r.timestamp}</td>
          <td>${r.details || ''}</td>`;
        tbody.appendChild(tr);
      }
      $('#logsCount').textContent = `${rows.length} results`;
      const modal = new bootstrap.Modal($('#logsModal'));
      modal.show();

      // Simple search filter
      $('#logsSearch').value = '';
      $('#logsSearch').oninput = function() {
        const q = this.value.toLowerCase();
        let visible = 0;
        $$('#logsTable tbody tr').forEach(tr => {
          const txt = tr.textContent.toLowerCase();
          const show = txt.includes(q);
          tr.style.display = show ? '' : 'none';
          if (show) visible++;
        });
        $('#logsCount').textContent = `${visible} results`;
      };
    }

    async function loadGroups() {
      try {
        const res = await fetch('/groups/');
        const data = await res.json();
        const sel = $('#groupSelect');
        sel.innerHTML = '';
        (data.groups || []).forEach(g => {
          const opt = document.createElement('option');
          opt.value = g; opt.textContent = g; sel.appendChild(opt);
        });
        // Load dates for first group if available
        if (data.groups && data.groups.length > 0) {
          updateDateBar(data.groups[0]);
        }
      } catch (e) { console.error(e); }
    }

    async function updateDateBar(group) {
      if (!group) {
        $('#dateBar').style.display = 'none';
        $('#startDateHint').style.display = 'none';
        $('#endDateHint').style.display = 'none';
        return;
      }
      try {
        const res = await fetch(`/api/group_dates/?group=${encodeURIComponent(group)}`);
        const data = await res.json();
        if (data.start_date && data.end_date) {
          $('#startDateText').textContent = data.start_date;
          $('#endDateText').textContent = data.end_date;
          $('#dateBar').style.display = 'block';
          
          // Show date hints below input fields
          $('#startDateHint').textContent = `Starts from ${data.start_date}`;
          $('#endDateHint').textContent = `To ${data.end_date}`;
          $('#startDateHint').style.display = 'block';
          $('#endDateHint').style.display = 'block';
        } else {
          $('#dateBar').style.display = 'none';
          $('#startDateHint').style.display = 'none';
          $('#endDateHint').style.display = 'none';
        }
      } catch (e) {
        console.error(e);
        $('#dateBar').style.display = 'none';
        $('#startDateHint').style.display = 'none';
        $('#endDateHint').style.display = 'none';
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await loadGroups();
      // Default dates to last 30 days
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 29);
      const fmt = (d) => d.toISOString().slice(0,10);
      $('#startDate').value = fmt(start);
      $('#endDate').value = fmt(end);

      $('#analyzeBtn').addEventListener('click', analyze);
      $('#groupSelect').addEventListener('change', () => updateDateBar($('#groupSelect').value));
    });
  </script>
</body>
</html>