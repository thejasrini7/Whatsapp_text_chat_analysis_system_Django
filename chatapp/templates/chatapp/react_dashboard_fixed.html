{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token }}" />
  <title>Analytics Dashboard • WhatsApp Chat Analyzer</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23128C7E'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='28' fill='white'%3EW%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <!-- Note: This application uses vanilla JavaScript, not React -->
  <!-- Chart.js for sentiment analysis charts with fallback -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" 
    onload="console.log('✅ Chart.js loaded successfully');"
    onerror="
      console.error('❌ Primary Chart.js CDN failed, trying fallback...');
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
      script.onload = () => console.log('✅ Chart.js loaded from fallback CDN');
      script.onerror = () => console.error('❌ All Chart.js CDN sources failed');
      document.head.appendChild(script);
    ">
  </script>
  <!-- Babel for transpiling -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --primary: #128C7E;
      --primary-dark: #075E54;
      --secondary: #25D366;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --sidebar-width: 280px;
      --header-height: 70px;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --gradient: linear-gradient(135deg, #128C7E 0%, #25D366 100%);
    }

    /* Date Bar Styles */
    .date-bar {
      position: fixed;
      top: var(--header-height);
      left: 0;
      right: 0;
      height: 40px;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .date-bar-content {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .date-bar-icon {
      color: var(--primary);
    }

    .date-bar strong {
      color: var(--primary);
      font-weight: 700;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-white);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--text-dark);
      font-size: 1.25rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--border);
      color: var(--text-dark);
    }

    .modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .group-item {
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .group-item:hover {
      background: var(--bg-light);
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .group-item i {
      color: var(--primary);
      font-size: 1.1rem;
    }

    .group-item span {
      font-weight: 500;
      color: var(--text-dark);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .empty-state p {
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
    }

    .loading i {
      margin-right: 10px;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: var(--error);
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      z-index: 1000;
      box-shadow: var(--shadow);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary);
      text-decoration: none;
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .group-name {
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.1) 0%, rgba(37, 211, 102, 0.1) 100%);
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      border: 1px solid rgba(18, 140, 126, 0.2);
    }

    .btn-header {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: var(--bg-white);
      color: var(--text-muted);
      border-radius: 0.375rem;
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .btn-header:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: calc(var(--header-height) + 40px); /* Adjusted for date bar */
      left: 0;
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height) - 40px); /* Adjusted for date bar */
      background: var(--bg-white);
      border-right: 1px solid var(--border);
      padding: 1.5rem 0;
      overflow-y: auto;
      z-index: 999;
      box-shadow: var(--shadow);
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar-toggle {
      position: absolute;
      top: 1rem;
      right: -12px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .nav-menu {
      list-style: none;
      padding: 0 1rem;
    }

    .nav-item {
      margin-bottom: 0.5rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-link:hover {
      background: rgba(18, 140, 126, 0.05);
      color: var(--primary);
    }

    .nav-link.active {
      background: var(--gradient);
      color: white;
      box-shadow: var(--shadow);
    }

    .nav-link i {
      font-size: 1.125rem;
      width: 20px;
      text-align: center;
    }

    .nav-text {
      font-weight: 500;
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .nav-text {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar.collapsed .nav-link {
      justify-content: center;
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      margin-top: calc(var(--header-height) + 40px); /* Adjusted for date bar */
      padding: 2rem;
      min-height: calc(100vh - var(--header-height) - 40px); /* Adjusted for date bar */
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed ~ .main-content {
      margin-left: 70px;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 1.125rem;
    }

    .content-area {
      background: var(--bg-white);
      border-radius: 1rem;
      box-shadow: var(--shadow);
      min-height: 600px;
      position: relative;
    }

    .section-content {
      padding: 2rem;
      display: none;
    }

    .section-content.active {
      display: block;
    }

    .card {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(18, 140, 126, 0.3);
    }

    .btn-secondary {
      background: var(--bg-white);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
      color: var(--text-dark);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1);
    }

    .date-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .result-area {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-light);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      min-height: 200px;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .badge-error { background: rgba(239, 68, 68, 0.1); color: var(--error); }

    /* Summary Section Styles */
    .summary-main-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .summary-main-btn {
      padding: 1rem;
      height: auto;
      flex-direction: column;
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
    }

    .summary-main-btn i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .summary-main-btn.btn-primary {
      background: var(--gradient);
      border: none;
      color: white;
      box-shadow: var(--shadow);
    }

    .summary-main-btn.btn-secondary {
      background: var(--bg-white);
      color: var(--text-muted);
      border: 2px solid var(--border);
    }

    .summary-main-btn.btn-secondary:hover {
      background: var(--gradient);
      color: white;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .summary-sub-section {
      margin-bottom: 1.5rem;
    }

    .summary-sub-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .summary-sub-buttons .btn {
      padding: 1.25rem;
      height: auto;
      flex-direction: column;
      text-align: center;
      font-size: 1rem;
      position: relative;
    }

    .summary-sub-buttons .btn i {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .btn-subtitle {
      display: block;
      font-size: 0.75rem;
      font-weight: 400;
      opacity: 0.8;
      margin-top: 0.25rem;
      line-height: 1.2;
    }

    .user-selection-area {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 0.5rem;
      border: 1px solid var(--border);
    }

    /* Results formatting */
    .weekly-summary-item {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .weekly-summary-header {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .weekly-summary-content {
      color: var(--text-dark);
      line-height: 1.6;
      margin-top: 1rem;
    }

    .weekly-summary-content h4 {
      color: var(--primary);
      margin: 1rem 0 0.5rem 0;
      font-weight: 600;
      font-size: 1.1rem;
      border-left: 3px solid var(--primary);
      padding-left: 0.5rem;
    }

    .weekly-summary-content ul {
      margin: 0.5rem 0;
      padding-left: 0;
      list-style: none;
    }

    .weekly-summary-content li {
      margin: 0.8rem 0;
      padding-left: 1.2rem;
      position: relative;
    }

    .weekly-summary-content li:before {
      content: '•';
      color: var(--primary);
      font-weight: bold;
      position: absolute;
      left: 0;
    }

    .daily-summary-item {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .daily-summary-date {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .user-message-item {
      background: var(--bg-light);
      border-left: 3px solid var(--primary);
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: 0 0.25rem 0.25rem 0;
    }

    .message-datetime {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .message-text {
      color: var(--text-dark);
      line-height: 1.4;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.collapsed {
        transform: translateX(0);
        width: 70px;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .sidebar.collapsed ~ .main-content {
        margin-left: 70px;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 1rem;
      }
      
      .page-title {
        font-size: 1.5rem;
      }
      
      .date-range {
        grid-template-columns: 1fr;
      }
      
      .header {
        padding: 0 1rem;
      }
      
      .group-name {
        display: none;
      }

      .date-bar {
        height: 36px;
      }

      .date-bar-content {
        font-size: 0.8rem;
      }
    }

    /* Sentiment Analysis Dashboard Styles */
    .sentiment-dashboard {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Charts Container Enhancements */
    .sentiment-charts {
      display: flex !important;
      flex-direction: column;
      gap: 2rem;
      margin-top: 2rem;
      min-height: 600px;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .chart-container {
      background: var(--bg-white);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      min-height: 400px;
      display: block !important;
      visibility: visible !important;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-area {
      position: relative;
      width: 100%;
      height: 400px;
      min-height: 400px;
      display: block !important;
      visibility: visible !important;
    }

    .chart-area canvas {
      max-width: 100% !important;
      max-height: 400px !important;
      display: block !important;
      visibility: visible !important;
    }

    /* Force visibility for fallback charts */
    .chart-area > div {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* Enhanced hover effects for fallback charts */
    .hover-chart-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-chart-item:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: var(--primary) !important;
    }

    /* Header */
    .sentiment-header {
      margin-bottom: 2rem;
      position: relative;
    }

    .sentiment-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .sentiment-icon {
      color: #E04F4F;
      font-size: 1.5rem;
    }

    .sentiment-divider {
      height: 1px;
      background: linear-gradient(to right, var(--border), transparent);
      width: 100%;
    }

    /* Controls */
    .sentiment-controls {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .date-controls-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .date-input-group {
      display: flex;
      flex-direction: column;
    }

    .date-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .sentiment-date-input {
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--bg-white);
    }

    .sentiment-date-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1);
    }

    .sentiment-analyze-btn {
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 2rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .sentiment-analyze-btn:hover {
      background: #1EBE55;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    .sentiment-analyze-btn:active {
      transform: translateY(0);
    }

    /* Sentiment Overview Cards */
    .sentiment-overview {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .sentiment-card {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .sentiment-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      transition: all 0.3s ease;
    }

    .sentiment-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .sentiment-card:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Positive Card */
    .positive-card {
      background: linear-gradient(135deg, #EAF8F0 0%, #F0FDF4 100%);
      border-color: rgba(45, 180, 110, 0.2);
    }

    .positive-card::before {
      background: #2DB46E;
    }

    .positive-card:hover::before {
      width: 6px;
    }

    /* Neutral Card */
    .neutral-card {
      background: linear-gradient(135deg, #F5F6F7 0%, #F9FAFB 100%);
      border-color: rgba(136, 136, 136, 0.2);
    }

    .neutral-card::before {
      background: #888888;
    }

    .neutral-card:hover::before {
      width: 6px;
    }

    /* Negative Card */
    .negative-card {
      background: linear-gradient(135deg, #FDECEC 0%, #FEF2F2 100%);
      border-color: rgba(224, 79, 79, 0.2);
    }

    .negative-card::before {
      background: #E04F4F;
    }

    .negative-card:hover::before {
      width: 6px;
    }

    .sentiment-number {
      font-size: 3rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .sentiment-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Charts */
    .sentiment-charts {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .chart-container {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-area {
      position: relative;
      height: 300px;
      width: 100%;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 0.5rem;
    }

    .chart-area canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .chart-container {
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-area {
      position: relative;
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1rem;
      min-height: 300px;
      overflow: hidden;
    }

    .chart-area canvas {
      width: 100% !important;
      height: auto !important;
    }

    /* Loading State */
    .sentiment-loading {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .sentiment-loading p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Empty State */
    .sentiment-empty {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .sentiment-empty i {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .sentiment-empty h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .sentiment-empty p {
      color: var(--text-muted);
      font-size: 0.875rem;
      max-width: 400px;
      margin: 0 auto;
    }

    /* Gemini Enhanced Features Styles */
    .gemini-insights-section {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 2rem;
      margin-top: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .insights-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .insights-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .insights-header h3 i {
      color: var(--primary);
      font-size: 1.75rem;
    }

    .insights-subtitle {
      color: var(--text-muted);
      font-size: 0.875rem;
      font-style: italic;
    }

    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .insight-card {
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.02), rgba(37, 211, 102, 0.02));
      border: 1px solid rgba(18, 140, 126, 0.1);
      border-radius: 0.75rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
      display: flex;
      gap: 1rem;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(18, 140, 126, 0.15);
      border-color: rgba(18, 140, 126, 0.2);
    }

    .insight-card.full-width {
      grid-column: 1 / -1;
    }

    .insight-icon {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      width: 48px;
      height: 48px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(18, 140, 126, 0.3);
    }

    .insight-content {
      flex: 1;
    }

    .insight-content h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.75rem;
    }

    .insight-content p {
      color: var(--text-muted);
      font-size: 0.875rem;
      line-height: 1.5;
      margin: 0;
    }

    .insight-content ul {
      margin: 0;
      padding-left: 1.25rem;
      color: var(--text-muted);
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .insight-content li {
      margin-bottom: 0.5rem;
    }

    .insight-content li:last-child {
      margin-bottom: 0;
    }

    /* Emotion Chart Fallback Styles */
    .emotion-bars, .confidence-bars {
      padding: 1rem;
    }

    .emotion-bar-item, .confidence-bar-item {
      margin-bottom: 1rem;
    }

    .emotion-bar-item:last-child, .confidence-bar-item:last-child {
      margin-bottom: 0;
    }

    .emotion-label, .confidence-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      text-transform: capitalize;
    }

    .emotion-bar, .confidence-bar {
      height: 32px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      padding: 0 1rem;
      position: relative;
      overflow: hidden;
    }

    .emotion-count, .confidence-count {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-dark);
      z-index: 2;
      position: relative;
    }

    /* Confidence Legend */
    .confidence-legend {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .legend-color.high {
      background: #10b981;
    }

    .legend-color.medium {
      background: #f59e0b;
    }

    .legend-color.low {
      background: #ef4444;
    }

    /* Activity Analysis Dashboard Styles */
    .activity-dashboard {
      padding: 0;
    }

    .activity-header {
      margin-bottom: 2rem;
      position: relative;
    }

    .activity-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .activity-icon {
      color: var(--primary);
    }

    .activity-divider {
      height: 1px;
      background: linear-gradient(to right, var(--border), transparent);
      width: 100%;
    }

    .activity-controls {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .activity-date-input {
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--bg-white);
    }

    .activity-date-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1);
    }

    .activity-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-start;
    }

    .activity-analyze-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 2rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(18, 140, 126, 0.3);
    }

    .activity-analyze-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(18, 140, 126, 0.4);
    }

    .activity-export-btn {
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .activity-export-btn:hover {
      background: #1EBE55;
      transform: translateY(-1px);
    }

    /* Quick Insights */
    .quick-insights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .insight-card {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .insight-icon {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .insight-content {
      flex: 1;
    }

    .insight-title {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .insight-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    /* Week Navigation */
    .week-navigation {
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1rem;
    }

    .week-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .week-card {
      background: var(--bg-white);
      border: 2px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .week-card:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.05), rgba(37, 211, 102, 0.05));
      transform: translateY(-2px);
    }

    .week-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.1), rgba(37, 211, 102, 0.1));
    }

    .week-card-title {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .week-card-subtitle {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .week-card-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
    }

    .week-card-messages {
      color: var(--primary);
      font-weight: 600;
    }

    .week-card-users {
      color: var(--text-muted);
    }

    /* Analysis View */
    .analysis-view {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .period-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .period-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .period-actions {
      display: flex;
      gap: 0.75rem;
    }

    .user-filter-section {
      margin-bottom: 2rem;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-actions {
      display: flex;
      gap: 0.5rem;
    }

    .chart-zoom-btn {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.3s ease;
    }

    .chart-zoom-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Leaderboard */
    .leaderboard-container {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .leaderboard-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .leaderboard-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .leaderboard {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .leaderboard-item:hover {
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.05), rgba(37, 211, 102, 0.05));
      transform: translateX(4px);
    }

    .leaderboard-rank {
      background: var(--primary);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .leaderboard-rank.top-3 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
    }

    .leaderboard-user {
      flex: 1;
      font-weight: 500;
      color: var(--text-dark);
    }

    .leaderboard-count {
      color: var(--primary);
      font-weight: 600;
    }

    .leaderboard-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .leaderboard-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 2px;
      transition: width 1s ease;
    }

    /* Day Analysis Grid */
    .day-analysis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .user-messages-section {
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1.5rem;
    }

    .messages-list {
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .message-item {
      background: var(--bg-white);
      border-radius: 0.5rem;
      padding: 0.75rem;
      border-left: 3px solid var(--primary);
      font-size: 0.875rem;
    }

    .message-time {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .message-text {
      color: var(--text-dark);
      line-height: 1.4;
    }

    /* User Stats Grid */
    .user-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1.5rem;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .user-charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    /* Large Modal */
    .large-modal {
      max-width: 1200px;
      max-height: 90vh;
    }

    /* Tooltip Styles */
    .tooltip {
      position: absolute;
      top: 15px;
      right: 15px;
      display: inline-block;
    }

    .tooltip .tooltip-icon {
      background: var(--primary);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: help;
      transition: all 0.3s ease;
    }

    .tooltip .tooltip-icon:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .tooltip .tooltip-content {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-dark);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .tooltip .tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--text-dark) transparent transparent transparent;
    }

    .tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-content h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--secondary);
    }

    .tooltip-content p {
      margin: 0 0 8px 0;
    }

    .tooltip-content ul {
      margin: 8px 0 0 0;
      padding-left: 16px;
    }

    .tooltip-content li {
      margin: 4px 0;
    }

    /* Comprehensive History Styles */
    .history-item.comprehensive {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .history-header {
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.05) 0%, rgba(37, 211, 102, 0.05) 100%);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .status-icon {
      font-size: 1.2rem;
    }

    .analysis-type {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 1.1rem;
    }

    .analysis-date {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .history-actions {
      display: flex;
      gap: 0.5rem;
    }

    .history-content {
      padding: 1.5rem;
    }

    .history-section {
      margin-bottom: 1.5rem;
    }

    .history-section:last-child {
      margin-bottom: 0;
    }

    .history-section h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }

    .info-item {
      padding: 0.5rem;
      background: var(--bg-light);
      border-radius: 0.375rem;
      font-size: 0.9rem;
    }

    .highlights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 0.75rem;
    }

    .highlight-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-light);
      border-radius: 0.5rem;
      border-left: 3px solid var(--primary);
    }

    .highlight-item i {
      color: var(--primary);
      width: 16px;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(18, 140, 126, 0.1);
      border-radius: 0.375rem;
      font-size: 0.9rem;
      color: var(--primary-dark);
    }

    .result-item i {
      color: var(--primary);
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 0.375rem;
    }

    /* Q&A Modal Styles */
    .qa-input-section {
      margin-bottom: 2rem;
    }

    .question-input-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .question-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .question-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .quick-questions {
      margin-bottom: 1.5rem;
    }

    .quick-questions p {
      margin-bottom: 0.75rem;
      color: var(--text-dark);
      font-size: 0.9rem;
    }

    .quick-question-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .quick-chip {
      background: var(--bg-light);
      color: var(--text-dark);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .quick-chip:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }

    .qa-answer-section {
      margin: 2rem 0;
      padding: 1.5rem;
      background: var(--bg-light);
      border-radius: 12px;
      border-left: 4px solid var(--primary);
    }

    .answer-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      color: var(--primary);
      font-weight: 600;
    }

    .answer-content {
      color: var(--text-dark);
      line-height: 1.6;
    }

    .qa-loading {
      text-align: center;
      padding: 2rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .qa-help-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .qa-help-section h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .help-tips {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .help-tip {
      padding: 1rem;
      background: var(--bg-white);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .help-tip strong {
      color: var(--primary);
      display: block;
      margin-bottom: 0.5rem;
    }

    .help-tip {
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* Permanent Q&A Section Styles */
    .qa-section-permanent {
      background: var(--bg-white);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .qa-header h4 {
      color: var(--primary);
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .qa-input-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .qa-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .qa-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .quick-questions-permanent {
      margin-bottom: 1rem;
    }

    .quick-questions-permanent .quick-question-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .qa-answer-display {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }

    .answer-content .answer-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      color: var(--primary);
      font-weight: 600;
    }

    .answer-text {
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* Loading State */
    .activity-loading {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .activity-loading .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .activity-loading p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Empty State */
    .activity-empty {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .activity-empty i {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .activity-empty h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .activity-empty p {
      color: var(--text-muted);
      font-size: 0.875rem;
      max-width: 400px;
      margin: 0 auto;
    }

    /* Responsive Design for Activity Dashboard */
    @media (max-width: 768px) {
      .quick-insights {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .day-analysis-grid,
      .user-charts-grid {
        grid-template-columns: 1fr;
      }

      .period-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .activity-actions {
        flex-direction: column;
      }

      .activity-analyze-btn,
      .activity-export-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 2rem;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--bg-white);
      border-radius: 1rem;
      box-shadow: var(--shadow-lg);
      max-width: 800px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg-light);
      color: var(--text-dark);
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .message-item {
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid #E04F4F;
    }

    .message-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .message-user {
      font-weight: 600;
      color: var(--text-dark);
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .message-text {
      color: var(--text-dark);
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .message-explanation {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-style: italic;
      padding: 0.75rem;
      background: var(--bg-white);
      border-radius: 0.5rem;
      border-left: 3px solid #E04F4F;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sentiment-overview {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .date-controls-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .sentiment-card {
        padding: 1.5rem;
      }

      .sentiment-number {
        font-size: 2.5rem;
      }

      .modal-overlay {
        padding: 1rem;
      }

      .modal-content {
        max-height: 90vh;
      }

      .chart-area {
        padding: 0.5rem;
        min-height: 250px;
      }
    }

    @media (max-width: 480px) {
      .sentiment-controls {
        padding: 1rem;
      }

      .sentiment-analyze-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Event Dashboard Card Styles */
    .events-dashboard {
      margin: 1rem 0;
    }

    .dashboard-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-dark);
    }

    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .event-card {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .event-icon {
      width: 60px;
      height: 60px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .event-icon svg {
      width: 24px;
      height: 24px;
    }

    .event-details-panel {
      margin-top: 1.5rem;
      background: var(--bg-light);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      overflow: hidden;
      display: none;
    }

    .event-details-panel.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .event-details-header {
      background: var(--bg-white);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .event-details-header h4 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .event-details-content {
      max-height: 400px;
      overflow-y: auto;
    }

    .event-log-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      transition: background 0.2s ease;
    }

    .event-log-item:hover {
      background: var(--bg-white);
    }

    .event-log-item:last-child {
      border-bottom: none;
    }

    .event-log-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .event-log-content {
      flex: 1;
    }

    .event-log-action {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.25rem;
    }

    .event-log-details {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .event-log-timestamp {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .event-log-meta {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .event-log-sender,
    .event-log-timestamp {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .event-log-sender i,
    .event-log-timestamp i {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .event-info {
      flex: 1;
    }

    .event-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .event-count {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      line-height: 1;
      margin-bottom: 0.25rem;
    }

    .event-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .top-removers-section {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
    }

    .top-removers-section h4 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-dark);
    }

    .removers-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .remover-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--bg-light);
      border-radius: 0.5rem;
      border-left: 3px solid var(--error);
    }

    .remover-rank {
      font-weight: 700;
      color: var(--text-muted);
      font-size: 0.875rem;
      min-width: 20px;
    }

    .remover-name {
      flex: 1;
      font-weight: 500;
      color: var(--text-dark);
    }

    .remover-count {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Event Details Modal Styles */
    .event-details-modal {
      background: var(--bg-white);
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .event-details-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 1.5rem;
      text-align: center;
    }

    .event-details-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .event-details-header p {
      font-size: 1rem;
      opacity: 0.9;
    }

    .event-details-body {
      padding: 1.5rem;
    }

    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border-left-color: #3b82f6;
      color: var(--text-dark);
    }

    .event-summary {
      background: var(--bg-light);
      padding: 1.25rem;
      border-radius: 0.5rem;
    }

    .event-summary ul {
      margin-top: 1rem;
      padding-left: 0;
      list-style: none;
    }

    .event-summary li {
      padding: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-dark);
    }

    @media (max-width: 768px) {
      .events-grid {
        grid-template-columns: 1fr;
      }
      
      .event-card {
        padding: 1rem;
      }
      
      .event-icon {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
      }
      
      .event-count {
        font-size: 1.75rem;
      }

      .event-details-header {
        padding: 1rem;
      }

      .event-details-body {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/home" class="header-brand">
      <i class="fab fa-whatsapp"></i>
      WhatsApp Chat Analyzer
    </a>
    <div class="header-actions">
      <div class="group-name" id="currentGroup">
        <i class="fas fa-users"></i>
        <span id="groupNameText">Loading...</span>
      </div>
      <a href="/home" class="btn-header">
        <i class="fas fa-home"></i> Home
      </a>
    </div>
  </header>

  <!-- Date Bar -->
  {% if chat_start_date and chat_end_date %}
  <div class="date-bar">
    <div class="date-bar-content">
      <i class="fas fa-calendar-alt date-bar-icon"></i>
      <span>Using chat data from <strong>{{ chat_start_date }}</strong> to <strong>{{ chat_end_date }}</strong></span>
    </div>
  </div>
  {% endif %}

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-chevron-left"></i>
    </button>
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active" data-section="summary">
          <i class="fas fa-file-alt"></i>
          <span class="nav-text">Generate Summary</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="questions">
          <i class="fas fa-question-circle"></i>
          <span class="nav-text">Ask Questions</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="events">
          <i class="fas fa-calendar-alt"></i>
          <span class="nav-text">Group Events</span>
        </a>
      </li>
      
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="activity">
          <i class="fas fa-chart-line"></i>
          <span class="nav-text">Activity Analysis</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="history">
          <i class="fas fa-history"></i>
          <span class="nav-text">History</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <div class="page-header">
      <h1 class="page-title" id="pageTitle">Generate Summary</h1>
      <p class="page-subtitle" id="pageSubtitle">Create comprehensive summaries of your chat conversations </p>
    </div>

    <div class="content-area">
      <!-- Summary Section -->
      <div class="section-content active" id="summary-section">
        <!-- Main Summary Buttons -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-alt"></i>
              Summary Options
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Generate Summary</h4>
                  <p>Creates comprehensive summaries of your chat conversations using AI analysis.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Analyzes all messages in the selected date range</li>
                    <li>Identifies key topics and themes</li>
                    <li>Generates a structured summary with insights</li>
                  </ul>
                  <p><strong>Input:</strong> Select date range and click "Generate Summary"</p>
                </div>
              </div>
            </h3>
          </div>
          
          <!-- Main Buttons Row -->
          <div class="summary-main-buttons">
            <button class="btn btn-primary summary-main-btn" data-target="total-summary">
              <i class="fas fa-chart-line"></i>
              Total Summary
            </button>
            <button class="btn btn-secondary summary-main-btn" data-target="user-messages">
              <i class="fas fa-users"></i>
              User Messages
            </button>
          </div>
        </div>

        <!-- Date Range Selection (Common for all) -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-calendar"></i>
              Date Range
            </h3>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="summaryStartDate">
              {% if chat_start_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">Starts from {{ chat_start_date }}</div>{% endif %}
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="summaryEndDate">
              {% if chat_end_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">To {{ chat_end_date }}</div>{% endif %}
            </div>
          </div>
        </div>

        <!-- Total Summary Sub-options -->
        <div class="card summary-sub-section" id="total-summary" style="display: block;">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-line"></i>
              Total Summary Options
            </h3>
          </div>
          <div class="summary-sub-buttons">
            <button class="btn btn-primary" id="generateWeeklySummary">
              <i class="fas fa-calendar-alt"></i>
              Weekly Report
              <small class="btn-subtitle">Clear bullet points of all topics discussed</small>
            </button>
            <button class="btn btn-primary" id="generateBriefSummary">
              <i class="fas fa-file-text"></i>
              Brief Report
              <small class="btn-subtitle">Concise overview of main points</small>
            </button>
          </div>
        </div>

        <!-- User Messages Sub-options -->
        <div class="card summary-sub-section" id="user-messages" style="display: none;">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-users"></i>
              User Messages Options
            </h3>
          </div>
          <div class="summary-sub-buttons">
            <button class="btn btn-primary" id="generateDailyUserMessages">
              <i class="fas fa-calendar-day"></i>
              Show All User Messages
              <small class="btn-subtitle">Day-by-day with short summaries</small>
            </button>
            <button class="btn btn-primary" id="showUserWiseOptions">
              <i class="fas fa-user-edit"></i>
              User-wise Report
              <small class="btn-subtitle">Select user from dropdown</small>
            </button>
          </div>
          
          <!-- User Selection Dropdown (initially hidden) -->
          <div class="user-selection-area" id="userSelectionArea" style="display: none;">
            <div class="form-group">
              <label class="form-label">Select User</label>
              <select class="form-select" id="userDropdown">
                <option value="">Choose a user...</option>
              </select>
            </div>
            <button class="btn btn-primary" id="generateUserWiseReport">
              <i class="fas fa-user-circle"></i>
              Generate User Report
            </button>
          </div>
        </div>

        <!-- Results Area -->
        <div class="card">
          <div class="result-area" id="summaryResult">
            <div class="empty-state">
              <i class="fas fa-file-alt"></i>
              <p>Select a summary option above to analyze your chat</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions Section -->
      <div class="section-content" id="questions-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-question-circle"></i>
              Ask Questions About Your Chat
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Ask Questions</h4>
                  <p>Get AI-powered insights by asking questions about your chat data.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Uses advanced AI to understand your questions</li>
                    <li>Analyzes chat data to provide relevant answers</li>
                    <li>Handles various question types about users, messages, and patterns</li>
                  </ul>
                  <p><strong>Input:</strong> Type your question and click "Ask Question"</p>
                </div>
              </div>
            </h3>
          </div>
          <div class="form-group">
            <label class="form-label">Your Question</label>
            <textarea class="form-textarea" id="userQuestion" rows="3" 
                      placeholder="Ask anything about your chat... e.g., 'What were the main topics discussed?' or 'Who was most active?'"></textarea>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="questionStartDate">
              {% if chat_start_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">Starts from {{ chat_start_date }}</div>{% endif %}
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="questionEndDate">
              {% if chat_end_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">To {{ chat_end_date }}</div>{% endif %}
            </div>
          </div>
          <button class="btn btn-primary" id="askQuestion">
            <i class="fas fa-search"></i>
            Get Answer
          </button>
          <div class="result-area" id="questionResult">
            <div class="empty-state">
              <i class="fas fa-lightbulb"></i>
              <p>Ask a question to get insights from your chat data</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Events Section -->
      <div class="section-content" id="events-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-calendar-alt"></i>
              Group Events Analysis
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Group Events Analysis</h4>
                  <p>Tracks member changes and group activities in your WhatsApp group.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Detects when members are added, removed, or leave</li>
                    <li>Tracks group name and icon changes</li>
                    <li>Shows detailed information about each event</li>
                  </ul>
                  <p><strong>Input:</strong> Select date range and click "Analyze Events"</p>
                </div>
              </div>
            </h3>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="eventsStartDate">
              {% if chat_start_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">Starts from {{ chat_start_date }}</div>{% endif %}
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="eventsEndDate">
              {% if chat_end_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">To {{ chat_end_date }}</div>{% endif %}
            </div>
          </div>
          <button class="btn btn-primary" id="analyzeEvents">
            <i class="fas fa-chart-bar"></i>
            Analyze Events
          </button>
          <div class="result-area" id="eventsResult">
            <div class="empty-state">
              <i class="fas fa-calendar-check"></i>
              <p>Analyze group events like member additions, removals, and settings changes</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sentiment Section -->
      
        <!-- Q&A Help Modal -->
        <div class="modal-overlay" id="qaModal" style="display: none;">
          <div class="modal-content large-modal">
            <div class="modal-header">
              <h3 class="modal-title">
                <i class="fas fa-question-circle"></i>
                Ask Questions About Your Chat Data
              </h3>
              <button class="modal-close" onclick="closeQAModal()">&times;</button>
            </div>
            <div class="modal-body">
              <!-- Question Input Section -->
              <div class="qa-input-section">
                <div class="question-input-container">
                  <input type="text" id="questionInput" placeholder="Ask a question about your chat data..." class="question-input">
                  <button id="askQuestionBtn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Ask
                  </button>
                </div>
                <div class="quick-questions">
                  <p><strong>Quick Questions:</strong></p>
                  <div class="quick-question-chips">
                    <span class="quick-chip" onclick="askQuickQuestion('Who is the most active user?')">Who is the most active user?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What is the busiest day of the week?')">What is the busiest day of the week?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What time are most messages sent?')">What time are most messages sent?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('How many messages were sent this week?')">How many messages were sent this week?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('Show me the top 5 users')">Show me the top 5 users</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What are the most active hours?')">What are the most active hours?</span>
                  </div>
                </div>
              </div>

              <!-- Answer Display Section -->
              <div class="qa-answer-section" id="qaAnswerSection" style="display: none;">
                <div class="answer-container">
                  <div class="answer-header">
                    <i class="fas fa-robot"></i>
                    <span>Answer:</span>
                  </div>
                  <div class="answer-content" id="qaAnswerContent">
                    <!-- Answer will be displayed here -->
                  </div>
                </div>
              </div>

              <!-- Loading State -->
              <div class="qa-loading" id="qaLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Analyzing your question...</p>
              </div>

              <!-- Help Section -->
              <div class="qa-help-section">
                <h4><i class="fas fa-lightbulb"></i> How to Ask Questions</h4>
                <div class="help-tips">
                  <div class="help-tip">
                    <strong>User Questions:</strong> "Who is the most active user?", "Show me user activity for John"
                  </div>
                  <div class="help-tip">
                    <strong>Time Questions:</strong> "What's the busiest day?", "When are most messages sent?"
                  </div>
                  <div class="help-tip">
                    <strong>Activity Questions:</strong> "How many messages this week?", "Show me the leaderboard"
                  </div>
                  <div class="help-tip">
                    <strong>Data Questions:</strong> "What's the total message count?", "Show me weekly breakdown"
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Section -->
      <div class="section-content" id="activity-section">
        <div class="activity-dashboard">
          <!-- Header -->
          <div class="activity-header">
            <h2 class="activity-title">
              <i class="fas fa-chart-line activity-icon"></i>
              Activity Analysis
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Activity Analysis</h4>
                  <p>Views engagement patterns, peak times, and user activity in your group.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Shows daily and hourly activity patterns</li>
                    <li>Displays user engagement and message counts</li>
                    <li>Identifies peak activity times and trends</li>
                  </ul>
                  <p><strong>Input:</strong> Select date range and click "Analyze Activity"</p>
                </div>
              </div>
            </h2>
            <div class="activity-divider"></div>
          </div>

          <!-- Controls -->
          <div class="activity-controls">
            <div class="date-controls-row">
              <div class="date-input-group">
                <label class="date-label">Start Date</label>
                <input type="date" class="activity-date-input" id="activityStartDate">
                {% if chat_start_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">Starts from {{ chat_start_date }}</div>{% endif %}
              </div>
              <div class="date-input-group">
                <label class="date-label">End Date</label>
                <input type="date" class="activity-date-input" id="activityEndDate">
                {% if chat_end_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">To {{ chat_end_date }}</div>{% endif %}
              </div>
            </div>
            <div class="activity-actions">
              <button class="activity-analyze-btn" id="analyzeActivity">
                <i class="fas fa-chart-area"></i>
                Analyze Activity
              </button>
            </div>
          </div>

          <!-- Quick Insights -->
          <div class="quick-insights" id="quickInsights" style="display: none;">
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-calendar-day"></i></div>
              <div class="insight-content">
                <div class="insight-title">Most Active Day</div>
                <div class="insight-value" id="mostActiveDay">-</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-clock"></i></div>
              <div class="insight-content">
                <div class="insight-title">Peak Hour</div>
                <div class="insight-value" id="peakHour">-</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-comments"></i></div>
              <div class="insight-content">
                <div class="insight-title">Total Messages</div>
                <div class="insight-value" id="totalMessages">-</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-user-crown"></i></div>
              <div class="insight-content">
                <div class="insight-title">Most Active User</div>
                <div class="insight-value" id="mostActiveUser">-</div>
              </div>
            </div>
          </div>

          <!-- Week Cards for >7 days range -->
          <div class="week-navigation" id="weekNavigation" style="display: none;">
            <h3 class="section-title">Select Week to Analyze</h3>
            <div class="week-cards" id="weekCards">
              <!-- Week cards will be dynamically generated -->
            </div>
          </div>

          <!-- Analysis View -->
          <div class="analysis-view" id="analysisView" style="display: none;">
            <!-- Period Header -->
            <div class="period-header">
              <h3 class="period-title" id="periodTitle">Weekly Analysis</h3>
              <div class="period-actions">
                <button class="btn-secondary" id="backToWeeks" style="display: none;">
                  <i class="fas fa-arrow-left"></i>
                  Back to Weeks
                </button>
              </div>
            </div>

            <!-- User Filter -->
            <div class="user-filter-section">
              <label class="form-label">Filter by User</label>
              <select class="form-select" id="userFilter">
                <option value="">All Users</option>
                <!-- Users will be populated dynamically -->
              </select>
            </div>

            <!-- Q&A Section -->
            <div class="qa-section-permanent">
              <div class="qa-header">
                <h4><i class="fas fa-question-circle"></i> Ask Questions About Your Chat Data</h4>
              </div>
              <div class="qa-input-container">
                <input type="text" id="permanentQuestionInput" placeholder="Ask a question about your chat data..." class="qa-input">
                <button id="permanentAskBtn" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i>
                  Send
                </button>
              </div>
              <div class="quick-questions-permanent">
                <div class="quick-question-chips">
                  <span class="quick-chip" onclick="askPermanentQuestion('Who is the most active user?')">Who is the most active user?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('What is the busiest day?')">What is the busiest day?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('What time are most messages sent?')">What time are most messages sent?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('How many messages this week?')">How many messages this week?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('Who messages less often?')">Who messages less often?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('Show me weekly analysis')">Show me weekly analysis</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('What do the charts show?')">What do the charts show?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('Show me the leaderboard')">Show me the leaderboard</span>
                </div>
              </div>
              <div class="qa-answer-display" id="permanentAnswerDisplay" style="display: none;">
                <div class="answer-content">
                  <div class="answer-header">
                    <i class="fas fa-robot"></i>
                    <span>Answer:</span>
                  </div>
                  <div class="answer-text" id="permanentAnswerText"></div>
                </div>
              </div>
            </div>

            <!-- Charts Container -->
            <div class="charts-grid">
              <!-- Activity by Hour -->
              <div class="chart-container">
                <div class="chart-header">
                  <h4 class="chart-title">
                    <i class="fas fa-clock"></i>
                    Activity by Hour
                  </h4>
                  <div class="chart-actions">
                    <button class="chart-zoom-btn" id="zoomHourly">
                      <i class="fas fa-search-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="chart-area">
                  <canvas id="hourlyChart" width="800" height="300"></canvas>
                </div>
              </div>

              <!-- Activity by Day -->
              <div class="chart-container">
                <div class="chart-header">
                  <h4 class="chart-title">
                    <i class="fas fa-calendar-week"></i>
                    Activity by Day
                  </h4>
                  <div class="chart-actions">
                    <button class="chart-zoom-btn" id="zoomDaily">
                      <i class="fas fa-search-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="chart-area">
                  <canvas id="activityDailyChart" width="800" height="300"></canvas>
                </div>
              </div>

              <!-- User Activity Distribution -->
              <div class="chart-container">
                <div class="chart-header">
                  <h4 class="chart-title">
                    <i class="fas fa-users"></i>
                    User Activity Distribution
                  </h4>
                </div>
                <div class="chart-area">
                  <canvas id="userDistributionChart" width="400" height="400"></canvas>
                </div>
              </div>
            </div>

            <!-- Top Users Leaderboard -->
            <div class="leaderboard-container">
              <div class="leaderboard-header">
                <h4 class="leaderboard-title">
                  <i class="fas fa-trophy"></i>
                  Top Active Users
                </h4>
              </div>
              <div class="leaderboard" id="userLeaderboard">
                <!-- Leaderboard items will be populated dynamically -->
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div class="activity-loading" id="activityLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p id="loadingText">Analyzing activity patterns...</p>
            <div class="progress-bar" id="progressBar" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 10px;">
              <div class="progress-fill" id="progressFill" style="width: 0%; height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.3s ease;"></div>
            </div>
          </div>

          <!-- Empty State -->
          <div class="activity-empty" id="activityEmpty">
            <i class="fas fa-chart-line"></i>
            <h3>Ready to Analyze Activity</h3>
            <p>Select a date range and click "Analyze Activity" to discover usage patterns, peak times, and user engagement insights.</p>
          </div>
        </div>
      </div>

      <!-- Topics Section -->
      <div class="section-content" id="topics-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-tags"></i>
              Topic Analysis
            </h3>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="topicsStartDate">
              {% if chat_start_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">Starts from {{ chat_start_date }}</div>{% endif %}
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="topicsEndDate">
              {% if chat_end_date %}<div style="font-size: 0.9em; color: #666; margin-top: 5px;">To {{ chat_end_date }}</div>{% endif %}
            </div>
          </div>
          <button class="btn btn-primary" id="analyzeTopics">
            <i class="fas fa-brain"></i>
            Extract Topics
          </button>
          <div class="result-area" id="topicsResult">
            <div class="empty-state">
              <i class="fas fa-cloud"></i>
              <p>Identify and visualize the main topics discussed in your conversations</p>
            </div>
          </div>
        </div>
      </div>

      <!-- History Section -->
      <div class="section-content" id="history-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-history"></i>
              Analysis History
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Analysis History</h4>
                  <p>Reviews your previous analyses and results for easy access.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Stores all your previous analysis results</li>
                    <li>Shows timestamps and analysis types</li>
                    <li>Allows you to clear history when needed</li>
                  </ul>
                  <p><strong>Input:</strong> Automatically tracks all your analyses</p>
                </div>
              </div>
            </h3>
            <button class="btn btn-secondary" id="clearHistory">
              <i class="fas fa-trash"></i>
              Clear History
            </button>
          </div>
          <div class="result-area" id="historyList">
            <div class="empty-state">
              <i class="fas fa-clock"></i>
              <p>Your analysis history will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Group Selection Modal -->
  <div class="modal" id="groupSelectionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-users"></i> Select Group</h3>
        <button class="modal-close" onclick="closeGroupSelectionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="groupList"></div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeGroupSelectionModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Modern Analytics Dashboard JavaScript
    (function() {
      // Global state
      let currentGroup = '';
      let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
      let sentimentData = null;
      let activityData = null;
      let dailyChart = null;
      let userChart = null;
      let activityCharts = {};

      // Section metadata
      const sectionMeta = {
        summary: { title: 'Generate Summary', subtitle: 'Create comprehensive summaries of your chat conversations' },
        questions: { title: 'Ask Questions', subtitle: 'Get AI-powered insights from your chat data' },
        events: { title: 'Group Events Analysis', subtitle: 'Track member changes and group activities' },
        sentiment: { title: 'Sentiment Analysis', subtitle: 'Discover emotional patterns in conversations' },
        activity: { title: 'Activity Analysis', subtitle: 'View engagement patterns and peak times' },
        topics: { title: 'Topic Analysis', subtitle: 'Identify main discussion topics and themes' },
        history: { title: 'Analysis History', subtitle: 'Review your previous analyses and results' }
      };

      // Initialize the dashboard when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing dashboard...');
        initDashboard();
      });
      
      // Backup initialization if DOMContentLoaded already fired
      if (document.readyState === 'loading') {
        // DOMContentLoaded has not yet fired
      } else {
        // DOMContentLoaded has already fired
        console.log('DOM already ready, initializing immediately...');
        initDashboard();
      }

      // Main initialization function
      function initDashboard() {
        try {
          console.log('🚀 initDashboard called');
          // Get group from URL parameters
          const params = new URLSearchParams(window.location.search);
          const group = params.get('group');
          const groupNameText = document.getElementById('groupNameText');
          console.log('Group from URL:', group);
          console.log('Group name text element:', groupNameText);
          
          if (!groupNameText) {
            console.error('❌ Critical: groupNameText element not found!');
            return;
          }
          
          // Set group name or load groups for selection
          if (group) {
            console.log('✅ Setting group from URL:', group);
            groupNameText.textContent = group;
            currentGroup = group; // Set the global variable
            console.log('Current group set to:', currentGroup);
            // Make the group name clickable to change groups
            groupNameText.style.cursor = 'pointer';
            groupNameText.onclick = () => showGroupSelectionModal();
          } else {
            // Load available groups and show selection
            console.log('🔍 No group in URL, loading groups...');
            loadGroupsForSelection();
          }

          // Initialize sidebar and navigation
          initSidebar();
          
          // Initialize all section functionality
          initSummarySection();
          initQuestionsSection();
          initEventsSection();
          initSentimentSection();
          initActivitySection();
          initTopicsSection();
          initHistorySection();
          
          // Enable all functionality after DOM is ready
          setTimeout(() => {
            setDefaultDates();
            enableAllButtons();
          }, 100);
          
          console.log('✅ Dashboard initialization completed successfully');
        } catch (error) {
          console.error('❌ Critical error in dashboard initialization:', error);
          // Show error to user
          const groupNameText = document.getElementById('groupNameText');
          if (groupNameText) {
            groupNameText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Initialization Error';
            groupNameText.style.color = 'var(--error)';
            groupNameText.style.cursor = 'pointer';
            groupNameText.onclick = () => location.reload();
          }
        }
      }

      // Load groups for selection when no group is provided
      async function loadGroupsForSelection() {
        const groupNameText = document.getElementById('groupNameText');
        
        if (!groupNameText) {
          console.error('❌ groupNameText element not found!');
          return;
        }
        
        try {
          console.log('🔄 Loading groups...');
          groupNameText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading groups...';
          groupNameText.style.color = 'var(--text-muted)';
          
          // Add timeout to prevent infinite loading
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
          
          // Try multiple endpoints
          let response;
          try {
            response = await fetch('/api/groups/', {
              signal: controller.signal,
              headers: {
                'X-CSRFToken': getCsrfToken()
              }
            });
          } catch (apiError) {
            console.log('⚠️ /api/groups/ failed, trying /groups/...');
            response = await fetch('/groups/', {
              signal: controller.signal
            });
          }
          
          clearTimeout(timeoutId);
          console.log('📡 Groups response:', response.status, response.statusText);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          console.log('📊 Groups data:', data);
          const groups = data.groups || [];
          
          if (groups.length === 0) {
            console.log('⚠️ No groups found');
            groupNameText.innerHTML = '<i class="fas fa-folder-open"></i> No groups found - <a href="/home" style="color: var(--primary);">Upload chat</a>';
            groupNameText.style.color = 'var(--warning)';
          } else if (groups.length === 1) {
            // Auto-select if only one group
            console.log('✅ Auto-selecting single group:', groups[0]);
            selectGroup(groups[0]);
          } else {
            // Show group selection
            console.log('📂 Multiple groups found, showing selection');
            groupNameText.innerHTML = '<i class="fas fa-users"></i> Select Group (' + groups.length + ' available)';
            groupNameText.style.color = 'var(--primary)';
            groupNameText.style.cursor = 'pointer';
            groupNameText.onclick = () => showGroupSelectionModal(groups);
            
            // Auto-show selection modal after a short delay for better UX
            setTimeout(() => {
              showGroupSelectionModal(groups);
            }, 1000);
          }
        } catch (error) {
          console.error('❌ Error loading groups:', error);
          let errorMessage = 'Error loading groups - Click to retry';
          let iconClass = 'fas fa-exclamation-triangle';
          
          if (error.name === 'AbortError') {
            errorMessage = 'Request timed out - Click to retry';
            iconClass = 'fas fa-clock';
          } else if (error.message.includes('404')) {
            errorMessage = 'Groups endpoint not found - <a href="/home" style="color: var(--primary);">Go to Home</a>';
            iconClass = 'fas fa-server';
          } else if (error.message.includes('fetch')) {
            errorMessage = 'Network error - Click to retry';
            iconClass = 'fas fa-wifi';
          }
          
          groupNameText.innerHTML = `<i class="${iconClass}"></i> ${errorMessage}`;
          groupNameText.style.color = 'var(--error)';
          groupNameText.style.cursor = 'pointer';
          groupNameText.onclick = () => {
            console.log('🔄 Retrying group loading...');
            loadGroupsForSelection();
          };
        }
      }

      // Show group selection modal
      function showGroupSelectionModal(groups = null) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('groupSelectionModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'groupSelectionModal';
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h3><i class="fas fa-users"></i> Select Group</h3>
                <button class="modal-close" onclick="closeGroupSelectionModal()">&times;</button>
              </div>
              <div class="modal-body">
                <div id="groupList"></div>
                <div class="modal-actions">
                  <button class="btn btn-secondary" onclick="closeGroupSelectionModal()">Cancel</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
        
        // Load groups if not provided
        if (!groups) {
          loadGroupsForModal();
        } else {
          populateGroupList(groups);
        }
        
        modal.style.display = 'flex';
      }

      // Load groups for modal
      async function loadGroupsForModal() {
        const groupList = document.getElementById('groupList');
        groupList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading groups...</div>';
        
        try {
          const response = await fetch('/groups/');
          const data = await response.json();
          const groups = data.groups || [];
          populateGroupList(groups);
        } catch (error) {
          groupList.innerHTML = '<div class="error">Error loading groups. Please try again.</div>';
        }
      }

      // Populate group list
      function populateGroupList(groups) {
        const groupList = document.getElementById('groupList');
        
        if (groups.length === 0) {
          groupList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-users"></i>
              <p>No groups available. Please upload a chat file first.</p>
              <a href="/home" class="btn btn-primary">Go to Upload</a>
            </div>
          `;
        } else {
          groupList.innerHTML = groups.map(group => `
            <div class="group-item" onclick="selectGroup('${group}')">
              <i class="fas fa-users"></i>
              <span>${group}</span>
            </div>
          `).join('');
        }
      }

      // Select group
      function selectGroup(group) {
        console.log('✅ Group selected:', group);
        currentGroup = group;
        const groupNameText = document.getElementById('groupNameText');
        
        if (groupNameText) {
          groupNameText.innerHTML = `<i class="fas fa-users"></i> ${group}`;
          groupNameText.style.color = 'var(--primary)';
          groupNameText.style.cursor = 'pointer';
          groupNameText.onclick = () => showGroupSelectionModal();
        }
        
        // Close modal
        closeGroupSelectionModal();
        
        // Update URL with group parameter
        try {
          const url = new URL(window.location);
          url.searchParams.set('group', group);
          window.history.pushState({}, '', url);
        } catch (error) {
          console.warn('⚠️ Could not update URL:', error);
        }
        
        // Update analysis history display
        updateHistoryDisplay();
        
        console.log(`🎉 Successfully loaded group: ${group}`);
      }

      // Close group selection modal
      function closeGroupSelectionModal() {
        const modal = document.getElementById('groupSelectionModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // Initialize sidebar and navigation
      function initSidebar() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const navLinks = document.querySelectorAll('.nav-link');
        const sectionContents = document.querySelectorAll('.section-content');
        const pageTitle = document.getElementById('pageTitle');
        const pageSubtitle = document.getElementById('pageSubtitle');

        // Sidebar toggle
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
          });
        }

        // Section navigation
        navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.getAttribute('data-section');
            
            // Update active state
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            
            // Show corresponding section
            sectionContents.forEach(section => {
              section.classList.remove('active');
              if (section.id === `${sectionId}-section`) {
                section.classList.add('active');
              }
            });
            
            // Update page title and subtitle
            if (sectionMeta[sectionId]) {
              pageTitle.textContent = sectionMeta[sectionId].title;
              pageSubtitle.textContent = sectionMeta[sectionId].subtitle;
            }
          });
        });
      }

      // Initialize Summary Section
      function initSummarySection() {
        // Summary button event listeners
        document.getElementById('generateWeeklySummary')?.addEventListener('click', generateWeeklySummary);
        document.getElementById('generateBriefSummary')?.addEventListener('click', generateBriefSummary);
        document.getElementById('generateDailyUserMessages')?.addEventListener('click', generateDailyUserMessages);
        document.getElementById('showUserWiseOptions')?.addEventListener('click', showUserWiseOptions);
        document.getElementById('generateUserWiseReport')?.addEventListener('click', generateUserWiseReport);

        // Main button switching functionality
        document.querySelectorAll('.summary-main-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            // Update button states
            document.querySelectorAll('.summary-main-btn').forEach(b => {
              b.classList.remove('btn-primary');
              b.classList.add('btn-secondary');
            });
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary');
            
            // Hide all sub-sections
            document.querySelectorAll('.summary-sub-section').forEach(section => {
              section.style.display = 'none';
            });
            
            // Show selected sub-section
            const targetId = this.getAttribute('data-target');
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
              targetSection.style.display = 'block';
            }
          });
        });
      }

      // Initialize Questions Section
      function initQuestionsSection() {
        document.getElementById('askQuestion')?.addEventListener('click', askQuestion);
      }

      // Initialize Events Section
      function initEventsSection() {
        document.getElementById('analyzeEvents')?.addEventListener('click', analyzeEvents);
        initializeEventsDates();
      }

      // Initialize Events dates
      function initializeEventsDates() {
        const startDateInput = document.getElementById('eventsStartDate');
        const endDateInput = document.getElementById('eventsEndDate');
        
        if (startDateInput && endDateInput) {
          // Set default dates to 2024 range that contains data
          startDateInput.value = '2024-06-01';
          endDateInput.value = '2024-12-31';
        }
      }

      // Initialize Sentiment Section
      function initSentimentSection() {
        document.getElementById('analyzeSentiment')?.addEventListener('click', analyzeSentiment);
        initializeSentimentDates();
      }

      // Initialize Activity Section
      function initActivitySection() {
        document.getElementById('analyzeActivity')?.addEventListener('click', analyzeActivity);
        document.getElementById('backToWeeks')?.addEventListener('click', goBackToWeeks);
        document.getElementById('userFilter')?.addEventListener('change', handleUserFilterChange);
        
        // Initialize permanent Q&A functionality
        initializePermanentQA();
        
        // Initialize activity dates with a delay to ensure DOM is ready
        setTimeout(() => {
          initializeActivityDates();
        }, 200);
      }

      // Initialize Topics Section
      function initTopicsSection() {
        document.getElementById('analyzeTopics')?.addEventListener('click', analyzeTopics);
      }

      // Initialize History Section
      function initHistorySection() {
        document.getElementById('clearHistory')?.addEventListener('click', clearHistory);
        updateHistoryDisplay();
      }

      // Enable all buttons (remove any disabled states)
      function enableAllButtons() {
        console.log('🔓 Enabling all buttons...');
        
        // Remove disabled state from all buttons
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
          if (btn.hasAttribute('disabled')) {
            btn.removeAttribute('disabled');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
          }
        });
        
        // Remove disabled state from all inputs
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          if (input.hasAttribute('disabled')) {
            input.removeAttribute('disabled');
            input.style.opacity = '1';
          }
        });
        
        console.log('✅ All buttons and inputs enabled');
      }

      // Set default dates for all date inputs
      function setDefaultDates() {
        // Set default dates to a range that contains actual chat data (2020-2025)
        // Use a range that's likely to have data
        const startDate = new Date('2024-06-01'); // Mid-2024 should have data
        const endDate = new Date('2024-12-31');
        const formattedDate = (date) => date.toISOString().split('T')[0];
        
        console.log('Setting default dates:', formattedDate(startDate), 'to', formattedDate(endDate));
        
        // Set default dates for all date inputs
        document.querySelectorAll('input[type="date"]').forEach(input => {
          if (!input.value) {
            if (input.id.includes('Start')) {
              input.value = formattedDate(startDate);
            } else if (input.id.includes('End')) {
              input.value = formattedDate(endDate);
            }
          }
        });
      }

      // Initialize sentiment dates with default range (last 30 days)
      function initializeSentimentDates() {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        document.getElementById('sentimentStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('sentimentEndDate').value = today.toISOString().split('T')[0];
      }

      // Initialize activity dates with default range (last 30 days)
      function initializeActivityDates() {
        // Use the same date range as setDefaultDates to ensure consistency
        const startDate = new Date('2024-06-01'); // Mid-2024 should have data
        const endDate = new Date('2024-12-31');
        
        const startInput = document.getElementById('activityStartDate');
        const endInput = document.getElementById('activityEndDate');
        
        // Force set the values
        startInput.value = startDate.toISOString().split('T')[0];
        endInput.value = endDate.toISOString().split('T')[0];
        
        // Also set the attribute to ensure it's visible
        startInput.setAttribute('value', startDate.toISOString().split('T')[0]);
        endInput.setAttribute('value', endDate.toISOString().split('T')[0]);
      }

      // Utility functions
      function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
      }

      function showLoading(resultId) {
        const resultArea = document.getElementById(resultId);
        resultArea.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            Processing your request...
          </div>
        `;
      }

      function showError(resultId, message) {
        const resultArea = document.getElementById(resultId);
        resultArea.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
            <p style="color: var(--error);">${message}</p>
          </div>
        `;
      }

      function showResult(resultId, content) {
        const resultArea = document.getElementById(resultId);
        resultArea.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.6;">${content}</div>`;
      }

      function addToHistory(type, params, status = 'success', results = null) {
        const entry = {
          id: Date.now(),
          type,
          params,
          timestamp: new Date().toISOString(),
          status,
          results: results || {},
          // Store basic data
          fileInfo: {
            fileName: currentGroup || 'Unknown Group',
            uploadDate: new Date().toISOString(),
            dateRange: `${params.start_date || 'N/A'} - ${params.end_date || 'N/A'}`
          },
          highlights: {
            mostActiveUser: results?.mostActiveUser || 'N/A',
            overallSentiment: results?.sentiment || { positive: 0, negative: 0, neutral: 0 },
            peakActiveTime: results?.peakTime || 'N/A',
            totalParticipants: results?.totalUsers || 0,
            totalMessages: results?.totalMessages || 0
          },
          savedResults: {
            summary: results?.summary || null,
            groupEvents: results?.groupEvents || null,
            sentimentResult: results?.sentimentData || null,
            activityAnalysis: results?.activityData || null
          }
        };
        analysisHistory.unshift(entry);
        if (analysisHistory.length > 50) analysisHistory = analysisHistory.slice(0, 50);
        localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
        updateHistoryDisplay();
      }

      function updateHistoryDisplay() {
        const historyList = document.getElementById('historyList');
        if (analysisHistory.length === 0) {
          historyList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clock"></i>
              <p>Your analysis history will appear here</p>
            </div>
          `;
          return;
        }

        let content = '';
        analysisHistory.forEach(entry => {
          const date = new Date(entry.timestamp).toLocaleString();
          const statusIcon = entry.status === 'success' ? '✅' : '❌';
          
          // Extract highlights
          const highlights = entry.highlights || {};
          const fileInfo = entry.fileInfo || {};
          const savedResults = entry.savedResults || {};
          
          content += `
            <div class="history-item comprehensive">
              <div class="history-header">
                <div class="history-title">
                  <span class="status-icon">${statusIcon}</span>
                  <span class="analysis-type">${entry.type}</span>
                  <span class="analysis-date">${date}</span>
                </div>
                <div class="history-actions">
                  <button class="btn btn-sm btn-primary" onclick="viewFullAnalysis(${entry.id})">
                    <i class="fas fa-eye"></i> View Full
                  </button>
                  <button class="btn btn-sm btn-success" onclick="downloadReport(${entry.id})">
                    <i class="fas fa-download"></i> Export
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteHistoryEntry(${entry.id})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              
              <div class="history-content">
                <!-- File Information -->
                <div class="history-section">
                  <h4><i class="fas fa-file"></i> File Information</h4>
                  <div class="info-grid">
                    <div class="info-item">
                      <strong>File:</strong> ${fileInfo.fileName || 'Unknown'}
                    </div>
                    <div class="info-item">
                      <strong>Date Range:</strong> ${fileInfo.dateRange || 'N/A'}
                    </div>
                    <div class="info-item">
                      <strong>Participants:</strong> ${highlights.totalParticipants || 0}
                    </div>
                    <div class="info-item">
                      <strong>Messages:</strong> ${highlights.totalMessages || 0}
                    </div>
                  </div>
                </div>

                <!-- Highlights -->
                <div class="history-section">
                  <h4><i class="fas fa-star"></i> Quick Highlights</h4>
                  <div class="highlights-grid">
                    <div class="highlight-item">
                      <i class="fas fa-user"></i>
                      <span><strong>Most Active:</strong> ${highlights.mostActiveUser || 'N/A'}</span>
                    </div>
                    <div class="highlight-item">
                      <i class="fas fa-heart"></i>
                      <span><strong>Sentiment:</strong> 
                        ${highlights.overallSentiment?.positive || 0}% positive, 
                        ${highlights.overallSentiment?.negative || 0}% negative
                      </span>
                    </div>
                    <div class="highlight-item">
                      <i class="fas fa-clock"></i>
                      <span><strong>Peak Time:</strong> ${highlights.peakActiveTime || 'N/A'}</span>
                    </div>
                  </div>
                </div>

                <!-- Saved Results -->
                <div class="history-section">
                  <h4><i class="fas fa-save"></i> Saved Results</h4>
                  <div class="results-grid">
                    ${savedResults.summary ? '<div class="result-item"><i class="fas fa-file-alt"></i> Summary Available</div>' : ''}
                    ${savedResults.groupEvents ? '<div class="result-item"><i class="fas fa-calendar-alt"></i> Group Events</div>' : ''}
                    ${savedResults.sentimentResult ? '<div class="result-item"><i class="fas fa-heart"></i> Sentiment Analysis</div>' : ''}
                    ${savedResults.activityAnalysis ? '<div class="result-item"><i class="fas fa-chart-line"></i> Activity Analysis</div>' : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        historyList.innerHTML = content;
      }

      function formatDate(date) {
        return new Date(date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      async function makeRequest(url, data, timeout = 30000) {
        console.log('Making request to:', url, 'with data:', data);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
            body: JSON.stringify(data),
            signal: controller.signal
        });
          
          clearTimeout(timeoutId);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        return await response.json();
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('Request timed out. Please try again.');
          }
          throw error;
        }
      }

      // Summary Functions
      async function generateWeeklySummary() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!currentGroup) {
          showError('summaryResult', 'Please select a group first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'weekly_summary',
            start_date: startDate,
            end_date: endDate
          });
          
          let content = '';
          if (data.weekly_summaries && data.weekly_summaries.length > 0) {
            content = data.weekly_summaries.map(week => {
              console.log('Week data:', week);
              
              // Format the summary content with proper structure
              let formattedSummary = week.summary || 'No summary content available';
              
              // Check if this is a quota exceeded message and display it properly
              if (formattedSummary.includes('Summary temporarily unavailable due to technical issues')) {
                formattedSummary = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> ${formattedSummary}</div>`;
              } 
              // Handle structured format with sections (fallback summaries and normal AI summaries)
              else if (formattedSummary.includes('**ACTIVITY OVERVIEW**') || formattedSummary.includes('**MAIN DISCUSSION TOPICS**')) {
                // Format structured sections
                formattedSummary = formattedSummary
                  .replace(/\*\*([^*]+)\*\*:/g, '<h4 style="color: var(--primary); margin: 1rem 0 0.5rem 0; font-weight: 600;">$1</h4>')
                  .replace(/\*\*([^*]+)\*\*/g, '<strong style="color: var(--primary);">$1</strong>')
                  .replace(/\n/g, '<br>');
              } else {
                // Convert bullet points to proper HTML list
                if (formattedSummary.includes('*')) {
                  const bulletPoints = formattedSummary
                    .split('\n')
                    .filter(line => line.trim().startsWith('*'))
                    .map(line => line.replace(/^\*\s*/, '').trim())
                    .filter(line => line.length > 0);
                    
                  if (bulletPoints.length > 0) {
                    formattedSummary = '<ul>' + bulletPoints.map(point => `<li>${point}</li>`).join('') + '</ul>';
                  }
                }
              }
              
              return `
                <div class="weekly-summary-item">
                  <div class="weekly-summary-header">
                    ${week.date_range} (${week.message_count} messages, ${week.participant_count} participants)
                  </div>
                  <div class="weekly-summary-content">${formattedSummary}</div>
                </div>
              `;
            }).join('');
          } else {
            content = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No weekly summaries available for the selected date range.</div>';
          }
          
          document.getElementById('summaryResult').innerHTML = content;
          addToHistory('Weekly Summary', { dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('Weekly summary error:', error);
          showError('summaryResult', 'Failed to generate weekly summary. Please try again.');
        }
      }

      async function generateBriefSummary() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!currentGroup) {
          showError('summaryResult', 'Please select a group first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'brief',
            start_date: startDate,
            end_date: endDate
          });
          
          showResult('summaryResult', data.summary || 'No summary available.');
          addToHistory('Brief Summary', { dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('Brief summary error:', error);
          showError('summaryResult', 'Failed to generate brief summary. Please try again.');
        }
      }

      async function generateDailyUserMessages() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!currentGroup) {
          showError('summaryResult', 'Please select a group first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'user_messages',
            start_date: startDate,
            end_date: endDate
          });
          
          let content = '<div class="user-messages-container">';
          content += '<h4 style="color: #333; margin-bottom: 20px;">📋 All User Messages (Cleaned & Organized)</h4>';
          
          if (data.user_messages && data.user_messages.length > 0) {
            // Group messages by user
            const userGroups = {};
            data.user_messages.forEach(msg => {
              if (!userGroups[msg.sender]) {
                userGroups[msg.sender] = [];
              }
              userGroups[msg.sender].push(msg);
            });
            
            // Display each user's messages
            Object.keys(userGroups).forEach(user => {
              content += `<div class="user-section" style="margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #f9f9f9;">`;
              content += `<h5 style="color: #2c3e50; margin-bottom: 15px; font-weight: 600;">👤 ${user} (${userGroups[user].length} messages)</h5>`;
              
              // Show user's topics if available
              if (userGroups[user][0].topics && userGroups[user][0].topics.length > 0) {
                content += `<div style="margin-bottom: 10px; font-size: 14px; color: #666;"><strong>Discussion Topics:</strong> ${userGroups[user][0].topics.join(', ')}</div>`;
              }
              
              userGroups[user].forEach(msg => {
                content += `<div class="user-message-item" style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #3498db;">`;
                content += `<div class="message-datetime" style="font-size: 12px; color: #888; margin-bottom: 5px;">📅 ${msg.formatted_datetime}</div>`;
                
                // Format message content with proper line breaks and bullet points
                let formattedMessage = msg.cleaned_message;
                if (formattedMessage.includes('\n')) {
                  // Convert newlines to HTML breaks and format bullet points
                  formattedMessage = formattedMessage
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                      if (line.startsWith('•')) {
                        return `<div style="margin: 5px 0; padding-left: 15px;">📍 ${line.substring(1).trim()}</div>`;
                      }
                      return `<div style="margin: 5px 0;">${line}</div>`;
                    })
                    .join('');
                } else {
                  // For single line messages, just clean and display
                  formattedMessage = `<div style="line-height: 1.6;">${formattedMessage}</div>`;
                }
                
                content += `<div class="message-text" style="color: #333;">${formattedMessage}</div>`;
                content += `</div>`;
              });
              
              content += `</div>`;
            });
          } else {
            content += '<div style="text-align: center; color: #666; padding: 20px;">No meaningful messages found for the selected date range.</div>';
          }
          
          content += '</div>';
          
          document.getElementById('summaryResult').innerHTML = content;
          addToHistory('All User Messages', { dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('User messages error:', error);
          showError('summaryResult', 'Failed to generate user messages. Please try again.');
        }
      }

      async function showUserWiseOptions() {
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'user_wise',
            start_date: document.getElementById('summaryStartDate').value,
            end_date: document.getElementById('summaryEndDate').value
          });
          
          const userDropdown = document.getElementById('userDropdown');
          
          // Clear existing options (keep first option)
          userDropdown.innerHTML = '<option value="">Choose a user...</option>';
          
          if (data.users) {
            data.users.forEach(user => {
              const option = new Option(user, user);
              userDropdown.appendChild(option);
            });
          }
          
          document.getElementById('userSelectionArea').style.display = 'block';
        } catch (error) {
          console.error('Error loading users:', error);
          showError('summaryResult', 'Failed to load users. Please try again.');
        }
      }

      async function generateUserWiseReport() {
        const selectedUser = document.getElementById('userDropdown').value;
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!selectedUser) {
          showError('summaryResult', 'Please select a user first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'user_wise_detailed',
            user: selectedUser,
            start_date: startDate,
            end_date: endDate
          });
          
          let content = `<h4>Messages from ${selectedUser}</h4>`;
          if (data.user_messages) {
            content += data.user_messages.map(msg => 
              `<div class="user-message-item">
                <div class="message-datetime">${msg.datetime}</div>
                <div class="message-text">${msg.message}</div>
              </div>`
            ).join('');
          }
          
          document.getElementById('summaryResult').innerHTML = content;
          addToHistory('User-wise Report', { user: selectedUser, dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('User-wise report error:', error);
          showError('summaryResult', 'Failed to generate user-wise report. Please try again.');
        }
      }

      // Questions Function
      async function askQuestion() {
        const question = document.getElementById('userQuestion').value.trim();
        const startDate = document.getElementById('questionStartDate').value;
        const endDate = document.getElementById('questionEndDate').value;
        
        if (!question) {
          showError('questionResult', 'Please enter a question first.');
          return;
        }
        
        if (!currentGroup) {
          showError('questionResult', 'Please select a group first.');
          return;
        }
        
        showLoading('questionResult');
        
        try {
          const data = await makeRequest('/ask/', {
            group_name: currentGroup,
            question: question,
            start_date: startDate,
            end_date: endDate
          });
          
          showResult('questionResult', data.answer || 'No answer received');
          addToHistory('Ask Questions', { question: question.substring(0, 50) + '...', start_date: 'N/A', end_date: 'N/A' }, 'success', {
            answer: data.answer
          });
        } catch (error) {
          console.error('Question error:', error);
          showError('questionResult', 'Failed to get answer. Please try again.');
        }
      }

      // Events Function
      async function analyzeEvents() {
        const startDate = document.getElementById('eventsStartDate').value;
        const endDate = document.getElementById('eventsEndDate').value;
        
        console.log('Analyzing events for group:', currentGroup);
        console.log('Date range:', startDate, 'to', endDate);
        
        if (!currentGroup) {
          showError('eventsResult', 'Please select a group first.');
          return;
        }
        
        showLoading('eventsResult');
        
        try {
          const data = await makeRequest('/group_events/', {
            group_name: currentGroup,
            start_date: startDate,
            end_date: endDate
          });
          
          console.log('Events data received:', data);
          
          // Create modern card-based dashboard design
          let content = '';
          
          if (data.event_counts) {
            console.log('Event counts:', data.event_counts);
            
            // Debug: Show if any events were found
            const totalEvents = Object.values(data.event_counts).reduce((sum, count) => sum + count, 0);
            console.log('Total events found:', totalEvents);
            content += '<div class="events-dashboard">';
            content += '<h3 class="dashboard-title">Group Events Summary</h3>';
            content += '<div class="events-grid">';
            
            const eventTypes = [
              {
                key: 'added', 
                title: 'Added', 
                color: '#22c55e',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>`
              },
              {
                key: 'left', 
                title: 'Left', 
                color: '#ef4444',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`
              }, 
              {
                key: 'removed', 
                title: 'Removed', 
                color: '#f97316',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`
              },
              {
                key: 'changed_subject', 
                title: 'Subject Changed', 
                color: '#3b82f6',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>`
              },
              {
                key: 'changed_icon', 
                title: 'Icon Changed', 
                color: '#8b5cf6',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>`
              },
              {
                key: 'created', 
                title: 'Group Created', 
                color: '#10b981',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
              }
            ];
            
            eventTypes.forEach(event => {
              const count = data.event_counts[event.key] || 0;
              console.log(`Creating card for ${event.key}: ${count} events`);
              content += `
                <div class="event-card" style="border-left: 4px solid ${event.color}; cursor: pointer;" onclick="toggleEventDetails('${event.key}', '${event.title}', ${count}, '${event.color}')">
                  <div class="event-icon" style="background: ${event.color}20; color: ${event.color};">
                    ${event.icon}
                  </div>
                  <div class="event-info">
                    <div class="event-title">${event.title}</div>
                    <div class="event-count">${count}</div>
                    <div class="event-label">events</div>
                  </div>
                </div>
              `;
            });
            
            content += '</div>';
            
            // Add expandable details panel
            content += '<div id="eventDetailsPanel" class="event-details-panel"></div>';
            
            // Add top removers section if available
            if (data.top_removers && data.top_removers.length > 0) {
              content += '<div class="top-removers-section">';
              content += '<h4>Top Removers:</h4>';
              content += '<div class="removers-list">';
              data.top_removers.forEach((remover, i) => {
                content += `
                  <div class="remover-item">
                    <span class="remover-rank">${i + 1}.</span>
                    <span class="remover-name">${remover.user}</span>
                    <span class="remover-count">${remover.count} removals</span>
                  </div>
                `;
              });
              content += '</div></div>';
            }
            
            content += '</div>';
          } else {
            console.log('No event_counts in response');
            content = '<div class="empty-state"><i class="fas fa-info-circle"></i><p>No events found in the selected date range. Try a different date range or check if the group has any system messages.</p></div>';
          }
          
          showResult('eventsResult', content);
          addToHistory('Group Events Analysis', { start_date: startDate, end_date: endDate }, 'success', {
            groupEvents: data,
            totalEvents: Object.values(data.event_counts || {}).reduce((a, b) => a + b, 0)
          });
        } catch (error) {
          console.error('Events error:', error);
          let errorMessage = 'Failed to analyze events. Please try again.';
          if (error.message) {
            errorMessage = `Error: ${error.message}`;
          }
          showError('eventsResult', errorMessage);
        }
      }

      // Function to get the appropriate icon for an event type
      function getEventIcon(eventType, color) {
        const icons = {
          'added': `<svg fill="${color}" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>`,
          'left': `<svg fill="${color}" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`,
          'removed': `<svg fill="${color}" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`,
          'changed_subject': `<svg fill="${color}" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>`,
          'changed_icon': `<svg fill="${color}" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>`,
          'created': `<svg fill="${color}" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
        };
        return icons[eventType] || '';
      }

      // Event Details Function with expandable functionality
      async function toggleEventDetails(eventType, eventTitle, count, color) {
        console.log('toggleEventDetails called:', { eventType, eventTitle, count, color });
        const panel = document.getElementById('eventDetailsPanel');
        
        if (!panel) {
          console.error('eventDetailsPanel not found!');
          return;
        }
        
        if (count === 0) {
          console.log('No events found for', eventType);
          panel.innerHTML = `
            <div class="event-details-header">
              <h4><i class="fas fa-info-circle"></i> ${eventTitle} Events</h4>
            </div>
            <div class="event-details-content">
              <div class="event-log-item">
                <div class="event-log-content">
                  <div class="event-log-details">No ${eventType.replace('_', ' ')} events found in the selected date range.</div>
                </div>
              </div>
            </div>
          `;
          panel.classList.add('show');
          return;
        }
        
        // Toggle panel visibility
        if (panel.classList.contains('show') && panel.dataset.currentEventType === eventType) {
          panel.classList.remove('show');
          return;
        }
        
        // Show loading state
        panel.innerHTML = `
          <div class="event-details-header">
            <h4>${getEventIcon(eventType, color)} ${eventTitle} Events (${count})</h4>
          </div>
          <div class="event-details-content">
            <div class="event-log-item">
              <div class="event-log-icon" style="background: var(--border); color: var(--text-muted);">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="event-log-content">
                <div class="event-log-details">Loading event details...</div>
              </div>
            </div>
          </div>
        `;
        panel.classList.add('show');
        panel.dataset.currentEventType = eventType;
        
        try {
          // Fetch detailed event logs
          const startDate = document.getElementById('eventsStartDate').value;
          const endDate = document.getElementById('eventsEndDate').value;
          
          console.log('Fetching event details for:', { group_name: currentGroup, event_type: eventType, start_date: startDate, end_date: endDate });
          
          const data = await makeRequest('/event_details/', {
            group_name: currentGroup,
            event_type: eventType,
            start_date: startDate,
            end_date: endDate
          });
          
          console.log('Event details response:', data);
          
          let content = `
            <div class="event-details-header">
              <h4>${getEventIcon(eventType, color)} ${eventTitle} Events (${data.events.length})</h4>
            </div>
            <div class="event-details-content">
          `;
          
          if (data.events.length === 0) {
            content += `
              <div class="event-log-item">
                <div class="event-log-content">
                  <div class="event-log-details">No events found in the selected date range.</div>
                </div>
              </div>
            `;
          } else {
            data.events.forEach(event => {
              const logIcon = getEventIcon(eventType, color);
              content += `
                <div class="event-log-item">
                  <div class="event-log-icon" style="background: ${color}20; color: ${color};">
                    ${logIcon}
                  </div>
                  <div class="event-log-content">
                    <div class="event-log-action">${event.details || event.raw_message}</div>
                    <div class="event-log-details">
                      <span class="event-log-meta">
                        <span class="event-log-sender"><i class="fas fa-user"></i> ${event.sender}</span>
                        <span class="event-log-timestamp"><i class="fas fa-clock"></i> ${event.timestamp}</span>
                      </span>
                    </div>
                  </div>
                </div>
              `;
            });
          }
          
          content += '</div>';
          panel.innerHTML = content;
        } catch (error) {
          console.error('Error fetching event details:', error);
          panel.innerHTML = `
            <div class="event-details-header">
              <h4>${getEventIcon(eventType, color)} ${eventTitle} Events</h4>
            </div>
            <div class="event-details-content">
              <div class="event-log-item">
                <div class="event-log-content">
                  <div class="event-log-details">Error loading event details: ${error.message}</div>
                </div>
              </div>
            </div>
          `;
        }
      }

      // Debug function to check Chart.js and canvas availability
      function debugChartSetup() {
        console.log('=== Chart Debug Info ===');
        console.log('Chart.js available:', typeof Chart !== 'undefined');
        console.log('Daily canvas element:', document.getElementById('dailyChart'));
        console.log('User canvas element:', document.getElementById('userChart'));
        console.log('Sentiment charts container:', document.getElementById('sentimentCharts'));
        console.log('Sentiment overview:', document.getElementById('sentimentOverview'));
        console.log('========================');
      }

      // Sentiment Functions
      async function analyzeSentiment() {
        const startDate = document.getElementById('sentimentStartDate').value;
        const endDate = document.getElementById('sentimentEndDate').value;
        
        if (!currentGroup) {
          showError('sentimentResult', 'Please select a group first.');
          return;
        }
        
        if (!startDate || !endDate) {
          alert('Please select both start and end dates.');
          return;
        }
        
        console.log('🧠 Starting sentiment analysis...', { group: currentGroup, startDate, endDate });
        
        // Show loading state
        document.getElementById('sentimentLoading').style.display = 'block';
        document.getElementById('sentimentEmpty').style.display = 'none';
        document.getElementById('sentimentOverview').style.display = 'none';
        document.getElementById('sentimentCharts').style.display = 'none';
        
        try {
          console.log('📡 Making sentiment analysis request for group:', currentGroup);
          const data = await makeRequest('/sentiment/', {
            group_name: currentGroup,
            start_date: startDate,
            end_date: endDate
          });
          
          console.log('✅ Sentiment analysis response:', data);
          
          // Store data globally for access by other functions
          window.sentimentData = data;
          
          // Handle API errors gracefully
          if (data.error) {
            throw new Error(data.error);
          }
          
          // Validate response data
          if (!data.sentiment_breakdown && !data.overall_sentiment) {
            throw new Error('No sentiment data received from server');
          }
          
          // Extract sentiment counts from the correct properties
          const sentimentBreakdown = data.sentiment_breakdown || data.overall_sentiment || {};
          const positiveCount = sentimentBreakdown.positive || 0;
          const neutralCount = sentimentBreakdown.neutral || 0;
          const negativeCount = sentimentBreakdown.negative || 0;
          
          console.log('📊 Sentiment counts:', { positiveCount, neutralCount, negativeCount });
          
          // Validate we have meaningful data
          const totalCount = positiveCount + neutralCount + negativeCount;
          if (totalCount === 0) {
            throw new Error('No sentiment data found. The messages may not contain analyzable content.');
          }
          
          // Update sentiment counts in the UI
          document.getElementById('positiveCount').textContent = positiveCount;
          document.getElementById('neutralCount').textContent = neutralCount;
          document.getElementById('negativeCount').textContent = negativeCount;
          
          // Hide loading and show results
          document.getElementById('sentimentLoading').style.display = 'none';
          document.getElementById('sentimentOverview').style.display = 'grid';
          document.getElementById('sentimentCharts').style.display = 'flex';
          
          // Display insights section
          displaySentimentInsights(data);
          
          // Create charts with delay to ensure elements are visible
          setTimeout(() => {
            console.log('📊 Creating charts after UI update...');
            
            // Force display charts container
            const chartsContainer = document.getElementById('sentimentCharts');
            if (chartsContainer) {
              chartsContainer.style.display = 'flex';
              chartsContainer.style.flexDirection = 'column';
              chartsContainer.style.gap = '2rem';
              chartsContainer.style.visibility = 'visible';
              chartsContainer.style.opacity = '1';
              console.log('✅ Charts container forced to display');
            }
            
            // Check if Chart.js is available and create charts
            if (typeof Chart !== 'undefined') {
              console.log('✅ Chart.js available, creating interactive charts');
              createSentimentCharts(data);
              
              // Create enhanced Gemini charts if data available
              if (data.emotion_analysis || data.confidence_distribution) {
                createGeminiEnhancedCharts(data);
              }
            } else {
              console.log('⚠️ Chart.js not available, using fallback charts');
              createFallbackCharts(data);
            }
            
            // Force fallback charts if Chart.js charts don't appear after 2 seconds
            setTimeout(() => {
              const dailyChart = document.getElementById('dailyChart');
              const userChart = document.getElementById('userChart');
              
              // Check if charts are actually rendered
              const dailyChartRendered = window.dailyChart && window.dailyChart.canvas;
              const userChartRendered = window.userChart && window.userChart.canvas;
              
              if (!dailyChartRendered || !userChartRendered) {
                console.log('🔧 Chart.js charts failed to render, forcing enhanced fallback...');
                createFallbackCharts(data);
              }
            }, 2000);
            
          }, 500);
          
          // Add to history
          addToHistory('Sentiment Analysis', { 
            start_date: startDate, 
            end_date: endDate 
          }, 'success', {
            sentimentData: data,
            totalMessages: totalCount,
            sentiment: sentimentBreakdown
          });
          
          console.log('✅ Sentiment analysis completed successfully');
          
        } catch (error) {
          console.error('❌ Sentiment analysis error:', error);
          
          // Hide loading and show error
          document.getElementById('sentimentLoading').style.display = 'none';
          document.getElementById('sentimentEmpty').style.display = 'block';
          
          // Update empty state with error message
          const emptyState = document.getElementById('sentimentEmpty');
          emptyState.innerHTML = `
            <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
            <h3>Analysis Failed</h3>
            <p>Error: ${error.message}</p>
            <button class="btn btn-primary" onclick="analyzeSentiment()" style="margin-top: 1rem;">
              <i class="fas fa-redo"></i> Try Again
            </button>
          `;
        }
      }

      function createSentimentCharts(data) {
        console.log('🎨 Creating enhanced sentiment charts with hover functionality...', data);
        
        // Destroy existing charts if they exist
        if (window.dailyChart) {
          window.dailyChart.destroy();
          console.log('Destroyed existing daily chart');
        }
        if (window.userChart) {
          window.userChart.destroy();
          console.log('Destroyed existing user chart');
        }
        
        // Store message data globally for hover tooltips
        window.sentimentMessageData = {
          daily_messages: data.daily_messages || {},
          user_messages: data.user_messages || {},
          all_messages: data.all_messages_with_sentiment || []
        };
        
        // Multiple attempts with different timing
        const attemptChartCreation = (attempt = 1) => {
          console.log(`Chart creation attempt ${attempt}`);
          
          try {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
              console.error('Chart.js is not loaded! Retrying in 500ms...');
              if (attempt < 5) {
                setTimeout(() => attemptChartCreation(attempt + 1), 500);
              }
              return;
            }
            
            console.log('Chart.js is available, version:', Chart.version);
            
            // Get canvas elements and force proper sizing
            const dailyCanvas = document.getElementById('dailyChart');
            const userCanvas = document.getElementById('userChart');
            
            if (!dailyCanvas) {
              console.error('Daily chart canvas not found!');
              return;
            }
            if (!userCanvas) {
              console.error('User chart canvas not found!');
              return;
            }
            
            // Force canvas visibility and sizing
            const chartsContainer = document.getElementById('sentimentCharts');
            if (chartsContainer) {
              chartsContainer.style.display = 'flex';
              chartsContainer.style.flexDirection = 'column';
              chartsContainer.style.gap = '2rem';
              chartsContainer.style.visibility = 'visible';
            }
            
            // Force canvas container sizing
            dailyCanvas.parentElement.style.height = '400px';
            userCanvas.parentElement.style.height = '500px';
            dailyCanvas.style.maxHeight = '400px';
            userCanvas.style.maxHeight = '500px';
            
            console.log('Canvas elements configured:', {
              daily: dailyCanvas,
              user: userCanvas,
              dailyParent: dailyCanvas.parentElement,
              userParent: userCanvas.parentElement
            });
            
            // Prepare daily sentiment data with message mapping
            let dailyLabels = [];
            let dailyPositive = [];
            let dailyNeutral = [];
            let dailyNegative = [];
            let dailyMessageMap = {}; // For hover tooltips
            
            if (data.daily_sentiment && typeof data.daily_sentiment === 'object') {
              const sortedDates = Object.keys(data.daily_sentiment)
                .filter(date => date !== 'unknown')
                .sort();
              
              console.log('Processing daily sentiment dates:', sortedDates);
              
              sortedDates.forEach((date, index) => {
                const dayData = data.daily_sentiment[date];
                if (dayData) {
                  const formattedDate = new Date(date).toLocaleDateString();
                  dailyLabels.push(formattedDate);
                  dailyPositive.push(dayData.positive || 0);
                  dailyNeutral.push(dayData.neutral || 0);
                  dailyNegative.push(dayData.negative || 0);
                  
                  // Store messages for this date for hover tooltips
                  dailyMessageMap[index] = {
                    date: formattedDate,
                    messages: data.daily_messages ? data.daily_messages[date] || [] : [],
                    positive: dayData.positive || 0,
                    neutral: dayData.neutral || 0,
                    negative: dayData.negative || 0
                  };
                }
              });
            }
            
            console.log('Daily chart data:', { dailyLabels, dailyPositive, dailyNeutral, dailyNegative });
            
            // Create daily chart with enhanced hover tooltips
            try {
              const dailyCtx = dailyCanvas.getContext('2d');
              
              if (dailyLabels.length > 0) {
                window.dailyChart = new Chart(dailyCtx, {
                  type: 'line',
                  data: {
                    labels: dailyLabels,
                    datasets: [
                      {
                        label: 'Positive',
                        data: dailyPositive,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8
                      },
                      {
                        label: 'Neutral',
                        data: dailyNeutral,
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8
                      },
                      {
                        label: 'Negative',
                        data: dailyNegative,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'top',
                      },
                      tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#ccc',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                          title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const dayInfo = dailyMessageMap[dataIndex];
                            return dayInfo ? `📅 ${dayInfo.date}` : context[0].label;
                          },
                          beforeBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const dayInfo = dailyMessageMap[dataIndex];
                            if (dayInfo && dayInfo.messages.length > 0) {
                              const totalMessages = dayInfo.positive + dayInfo.neutral + dayInfo.negative;
                              return [`📊 Total Messages: ${totalMessages}`];
                            }
                            return [];
                          },
                          afterBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const dayInfo = dailyMessageMap[dataIndex];
                            if (dayInfo && dayInfo.messages.length > 0) {
                              const messagesToShow = dayInfo.messages.slice(0, 3); // Show first 3 messages
                              let result = ['\n💬 Sample Messages:'];
                              messagesToShow.forEach((msg, i) => {
                                const preview = msg.message ? msg.message.substring(0, 80) + (msg.message.length > 80 ? '...' : '') : 'No content';
                                const sentiment = msg.sentiment || 'unknown';
                                const emoji = sentiment === 'positive' ? '😊' : sentiment === 'negative' ? '😞' : '😐';
                                result.push(`${emoji} ${msg.sender || 'Unknown'}: ${preview}`);
                              });
                              if (dayInfo.messages.length > 3) {
                                result.push(`... and ${dayInfo.messages.length - 3} more messages`);
                              }
                              return result;
                            }
                            return ['No messages available for this date'];
                          }
                        }
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        ticks: {
                          precision: 0
                        }
                      }
                    },
                    interaction: {
                      mode: 'index',
                      intersect: false
                    }
                  }
                });
                console.log('✅ Daily chart with hover functionality created successfully:', window.dailyChart);
              } else {
                // Fallback: Create simple chart with message
                dailyCtx.clearRect(0, 0, dailyCanvas.width, dailyCanvas.height);
                dailyCtx.font = '16px Arial';
                dailyCtx.fillStyle = '#666';
                dailyCtx.textAlign = 'center';
                dailyCtx.fillText('No daily sentiment data available for selected date range', 
                  dailyCanvas.width / 2, dailyCanvas.height / 2);
                console.log('📊 Daily chart: No data, showing fallback message');
              }
            } catch (dailyError) {
              console.error('❌ Error creating daily chart:', dailyError);
              // Create fallback chart
              createFallbackCharts(data);
            }
            
            // Prepare user sentiment data with message mapping
            let userLabels = [];
            let userPositive = [];
            let userNeutral = [];
            let userNegative = [];
            let userMessageMap = {}; // For hover tooltips
            
            const userSentimentData = data.user_sentiment || data.user_sentiments || {};
            if (userSentimentData && typeof userSentimentData === 'object') {
              console.log('Processing user sentiment data:', userSentimentData);
              Object.entries(userSentimentData).forEach(([user, sentiments], index) => {
                if (sentiments && typeof sentiments === 'object') {
                  userLabels.push(user);
                  userPositive.push(sentiments.positive || 0);
                  userNeutral.push(sentiments.neutral || 0);
                  userNegative.push(sentiments.negative || 0);
                  
                  // Store user messages for hover tooltips
                  userMessageMap[index] = {
                    user: user,
                    messages: data.user_messages ? data.user_messages[user] || [] : [],
                    positive: sentiments.positive || 0,
                    neutral: sentiments.neutral || 0,
                    negative: sentiments.negative || 0
                  };
                }
              });
            }
            
            console.log('User chart data:', { userLabels, userPositive, userNeutral, userNegative });
            
            // Create user chart with enhanced hover tooltips
            try {
              const userCtx = userCanvas.getContext('2d');
              
              if (userLabels.length > 0) {
                window.userChart = new Chart(userCtx, {
                  type: 'bar',
                  data: {
                    labels: userLabels,
                    datasets: [
                      {
                        label: 'Positive',
                        data: userPositive,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                      },
                      {
                        label: 'Neutral',
                        data: userNeutral,
                        backgroundColor: 'rgba(107, 114, 128, 0.7)',
                        borderColor: 'rgba(107, 114, 128, 1)',
                        borderWidth: 1
                      },
                      {
                        label: 'Negative',
                        data: userNegative,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'top',
                      },
                      tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#ccc',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                          title: function(context) {
                            return `👤 ${context[0].label}`;
                          },
                          beforeBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const userInfo = userMessageMap[dataIndex];
                            if (userInfo) {
                              const totalMessages = userInfo.positive + userInfo.neutral + userInfo.negative;
                              return [`📊 Total Messages: ${totalMessages}`];
                            }
                            return [];
                          },
                          afterBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const userInfo = userMessageMap[dataIndex];
                            if (userInfo && userInfo.messages.length > 0) {
                              const messagesToShow = userInfo.messages.slice(0, 3); // Show first 3 messages
                              let result = ['\n💬 Recent Messages:'];
                              messagesToShow.forEach((msg, i) => {
                                const preview = msg.message ? msg.message.substring(0, 80) + (msg.message.length > 80 ? '...' : '') : 'No content';
                                const sentiment = msg.sentiment || 'unknown';
                                const emoji = sentiment === 'positive' ? '😊' : sentiment === 'negative' ? '😞' : '😐';
                                const timestamp = msg.timestamp ? new Date(msg.timestamp).toLocaleDateString() : '';
                                result.push(`${emoji} ${timestamp}: ${preview}`);
                              });
                              if (userInfo.messages.length > 3) {
                                result.push(`... and ${userInfo.messages.length - 3} more messages`);
                              }
                              return result;
                            }
                            return ['No messages available for this user'];
                          }
                        }
                      }
                    },
                    scales: {
                      x: {
                        stacked: true,
                      },
                      y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                          precision: 0
                        }
                      }
                    },
                    interaction: {
                      mode: 'index',
                      intersect: false
                    }
                  }
                });
                console.log('✅ User chart with hover functionality created successfully:', window.userChart);
              } else {
                // Fallback: Create simple chart with message
                userCtx.clearRect(0, 0, userCanvas.width, userCanvas.height);
                userCtx.font = '16px Arial';
                userCtx.fillStyle = '#666';
                userCtx.textAlign = 'center';
                userCtx.fillText('No user sentiment data available', 
                  userCanvas.width / 2, userCanvas.height / 2);
                console.log('📊 User chart: No data, showing fallback message');
              }
            } catch (userError) {
              console.error('❌ Error creating user chart:', userError);
              // Create fallback chart
              createFallbackCharts(data);
            }
            
            console.log('🎯 Enhanced chart creation process completed with hover functionality');
            
          } catch (error) {
            console.error('💥 Fatal error in chart creation:', error);
            if (attempt < 3) {
              console.log(`Retrying chart creation in 1000ms (attempt ${attempt + 1})`);
              setTimeout(() => attemptChartCreation(attempt + 1), 1000);
            } else {
              // Final fallback
              console.log('🔄 All chart attempts failed, creating fallback charts');
              createFallbackCharts(data);
            }
          }
        };
        
        // Start chart creation with initial delay
        setTimeout(() => attemptChartCreation(1), 200);
      }

      function showSentimentDetails(sentimentType) {
        if (!window.sentimentData) {
          console.log('No sentiment data available');
          alert('No sentiment data available. Please run sentiment analysis first.');
          return;
        }
        
        console.log('Showing sentiment details for:', sentimentType);
        console.log('Available sentiment data:', window.sentimentData);
        
        // Get messages based on sentiment type
        let filteredMessages = [];
        
        if (sentimentType === 'negative' && window.sentimentData.negative_messages) {
          filteredMessages = window.sentimentData.negative_messages;
        } else if (sentimentType === 'positive' || sentimentType === 'neutral') {
          // Filter from all messages with sentiment
          if (window.sentimentData.all_messages_with_sentiment) {
            filteredMessages = window.sentimentData.all_messages_with_sentiment.filter(msg => msg.sentiment === sentimentType);
          }
        }
        
        console.log('Filtered messages:', filteredMessages);
        
        if (filteredMessages.length === 0) {
          alert(`No ${sentimentType} messages found in the analysis.`);
          return;
        }
        
        // Show modal with messages
        const modal = document.getElementById('negativeModal');
        const messagesList = document.getElementById('negativeMessagesList');
        
        if (!modal || !messagesList) {
          console.error('Modal elements not found');
          alert('Modal elements not found. Please refresh the page.');
          return;
        }
        
        // Update modal title based on sentiment type
        const modalTitle = modal.querySelector('.modal-title');
        if (modalTitle) {
          const capitalizedType = sentimentType.charAt(0).toUpperCase() + sentimentType.slice(1);
          const emoji = sentimentType === 'positive' ? '😊' : sentimentType === 'negative' ? '😞' : '😐';
          modalTitle.innerHTML = `<i class="fas fa-${sentimentType === 'positive' ? 'smile' : sentimentType === 'negative' ? 'frown' : 'meh'}"></i> ${emoji} ${capitalizedType} Messages (${filteredMessages.length})`;
        }
        
        // Generate messages list
        messagesList.innerHTML = '';
        filteredMessages.slice(0, 50).forEach((msg, index) => { // Show up to 50 messages
          const messageEl = document.createElement('div');
          messageEl.className = `message-item ${sentimentType}-message`;
          
          const timestamp = msg.timestamp || 'Unknown time';
          const sender = msg.sender || 'Unknown sender';
          const message = msg.message || 'No message content';
          const polarity = msg.polarity ? msg.polarity.toFixed(3) : 'N/A';
          const confidence = msg.confidence ? Math.round(msg.confidence * 100) + '%' : 'N/A';
          const emotion = msg.emotion || 'unknown';
          const reason = msg.reason || 'General sentiment analysis';
          
          // Format timestamp
          let formattedTime = timestamp;
          try {
            if (timestamp !== 'Unknown time') {
              formattedTime = new Date(timestamp).toLocaleString();
            }
          } catch (e) {
            formattedTime = timestamp;
          }
          
          // Determine background color based on sentiment
          const bgColor = sentimentType === 'positive' ? '#f0fdf4' : 
                         sentimentType === 'negative' ? '#fef2f2' : '#f9fafb';
          const borderColor = sentimentType === 'positive' ? '#10b981' : 
                             sentimentType === 'negative' ? '#ef4444' : '#6b7280';
          
          messageEl.innerHTML = `
            <div class="message-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div class="message-user" style="font-weight: bold; color: ${borderColor};">👤 ${sender}</div>
              <div class="message-time" style="font-size: 0.8em; color: #666;">🕐 ${formattedTime}</div>
            </div>
            <div class="message-text" style="margin: 10px 0; padding: 12px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 6px; line-height: 1.4;">${message}</div>
            <div class="message-explanation" style="font-size: 0.85em; color: #666; background: #f8f9fa; padding: 8px; border-radius: 4px;">
              <div style="margin-bottom: 4px;"><strong>🎯 Sentiment:</strong> ${sentimentType} (Confidence: ${confidence})</div>
              <div style="margin-bottom: 4px;"><strong>🎨 Emotion:</strong> ${emotion} | <strong>📊 Score:</strong> ${polarity}</div>
              <div><strong>🔍 Reason:</strong> ${reason}</div>
            </div>
          `;
          
          messageEl.style.cssText = `
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid ${borderColor};
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          `;
          
          messagesList.appendChild(messageEl);
        });
        
        // Add summary at the top
        if (filteredMessages.length > 50) {
          const summaryEl = document.createElement('div');
          summaryEl.innerHTML = `
            <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; color: #1565c0;">
              📊 Showing first 50 of ${filteredMessages.length} ${sentimentType} messages
            </div>
          `;
          messagesList.insertBefore(summaryEl, messagesList.firstChild);
        }
        
        modal.style.display = 'flex';
        console.log(`✅ Successfully displayed ${filteredMessages.length} ${sentimentType} messages`);
      }

      function closeNegativeModal() {
        document.getElementById('negativeModal').style.display = 'none';
      }

      // Activity Functions
      async function analyzeActivity() {
        const startDate = document.getElementById('activityStartDate').value;
        const endDate = document.getElementById('activityEndDate').value;
        
        if (!currentGroup) {
          showError('activityResult', 'Please select a group first.');
          return;
        }
        
        // Show loading state
        document.getElementById('activityLoading').style.display = 'block';
        document.getElementById('activityEmpty').style.display = 'none';
        document.getElementById('quickInsights').style.display = 'none';
        document.getElementById('weekNavigation').style.display = 'none';
        document.getElementById('analysisView').style.display = 'none';
        
        try {
          const data = await makeRequest('/activity_analysis/', {
            group_name: currentGroup,
            start_date: startDate,
            end_date: endDate
          });
          
          activityData = data;
          
          // Hide loading and show results
          document.getElementById('activityLoading').style.display = 'none';
          
          // Check if we have weeks data
          if (data.weeks && data.weeks.length > 1) {
            // Show week navigation
            document.getElementById('weekNavigation').style.display = 'block';
            renderWeekCards(data.weeks);
          } else {
            // Show analysis view directly
            document.getElementById('analysisView').style.display = 'block';
            renderActivityAnalysis(data);
          }
          
          // Update quick insights
          updateQuickInsights(data);
          document.getElementById('quickInsights').style.display = 'grid';
          
          addToHistory('Activity Analysis', { start_date: startDate, end_date: endDate }, 'success', {
            activityData: data
          });
        } catch (error) {
          console.error('Activity analysis error:', error);
          document.getElementById('activityLoading').style.display = 'none';
          document.getElementById('activityEmpty').style.display = 'block';
          showError('activityResult', 'Failed to analyze activity. Please try again.');
        }
      }

      function renderWeekCards(weeks) {
        const weekCards = document.getElementById('weekCards');
        weekCards.innerHTML = '';
        
        weeks.forEach((week, index) => {
          const card = document.createElement('div');
          card.className = 'week-card';
          card.innerHTML = `
            <div class="week-card-title">Week ${index + 1}</div>
            <div class="week-card-subtitle">${week.start} to ${week.end}</div>
            <div class="week-card-stats">
              <span class="week-card-messages">${week.message_count} messages</span>
              <span class="week-card-users">${week.users.length} users</span>
            </div>
          `;
          
          card.addEventListener('click', () => {
            // Select this week
            document.querySelectorAll('.week-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            // Show analysis view for this week
            document.getElementById('analysisView').style.display = 'block';
            document.getElementById('backToWeeks').style.display = 'inline-flex';
            document.getElementById('periodTitle').textContent = `Week ${index + 1} Analysis`;
            
            // Render analysis for this week
            renderActivityAnalysis(week);
          });
          
          weekCards.appendChild(card);
        });
      }

      function renderActivityAnalysis(data) {
        // Update user filter dropdown
        const userFilter = document.getElementById('userFilter');
        userFilter.innerHTML = '<option value="">All Users</option>';
        
        if (data.users) {
          data.users.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            userFilter.appendChild(option);
          });
        }
        
        // Create charts
        createActivityCharts(data);
        
        // Update leaderboard
        updateLeaderboard(data.message_counts || {});
      }

      function createActivityCharts(data) {
        // Destroy existing charts if they exist
        Object.values(activityCharts).forEach(chart => {
          if (chart) {
            chart.destroy();
          }
        });
        
        // Activity by hour chart
        const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
        activityCharts.hourly = new Chart(hourlyCtx, {
          type: 'bar',
          data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
              label: 'Messages',
              data: data.hourly_activity || Array(24).fill(0),
              backgroundColor: 'rgba(18, 140, 126, 0.7)',
              borderColor: 'rgba(18, 140, 126, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
        
        // Activity by day chart
        const dailyCtx = document.getElementById('activityDailyChart').getContext('2d');
        activityCharts.daily = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
            datasets: [{
              label: 'Messages',
              data: data.daily_activity || Array(7).fill(0),
              backgroundColor: 'rgba(37, 211, 102, 0.7)',
              borderColor: 'rgba(37, 211, 102, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
        
        // User distribution chart
        const userCtx = document.getElementById('userDistributionChart').getContext('2d');
        activityCharts.userDistribution = new Chart(userCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(data.message_counts || {}),
            datasets: [{
              data: Object.values(data.message_counts || {}),
              backgroundColor: [
                'rgba(18, 140, 126, 0.7)',
                'rgba(37, 211, 102, 0.7)',
                'rgba(59, 130, 246, 0.7)',
                'rgba(139, 92, 246, 0.7)',
                'rgba(236, 72, 153, 0.7)'
              ],
              borderColor: [
                'rgba(18, 140, 126, 1)',
                'rgba(37, 211, 102, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(139, 92, 246, 1)',
                'rgba(236, 72, 153, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
      }

      function updateQuickInsights(data) {
        // Find most active day
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const dailyActivity = data.daily_activity || Array(7).fill(0);
        const mostActiveDayIndex = dailyActivity.indexOf(Math.max(...dailyActivity));
        document.getElementById('mostActiveDay').textContent = dayNames[mostActiveDayIndex];
        
        // Find peak hour
        const hourlyActivity = data.hourly_activity || Array(24).fill(0);
        const peakHourIndex = hourlyActivity.indexOf(Math.max(...hourlyActivity));
        document.getElementById('peakHour').textContent = `${peakHourIndex}:00`;
        
        // Total messages
        const totalMessages = Object.values(data.message_counts || {}).reduce((sum, count) => sum + count, 0);
        document.getElementById('totalMessages').textContent = totalMessages.toLocaleString();
        
        // Most active user
        const messageCounts = data.message_counts || {};
        const mostActiveUser = Object.keys(messageCounts).reduce((a, b) => 
          messageCounts[a] > messageCounts[b] ? a : b, 'N/A');
        document.getElementById('mostActiveUser').textContent = mostActiveUser;
      }

      function updateLeaderboard(messageCounts) {
        const leaderboard = document.getElementById('userLeaderboard');
        leaderboard.innerHTML = '';
        
        // Sort users by message count
        const sortedUsers = Object.entries(messageCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10); // Top 10 users
        
        // Find max count for progress bar calculation
        const maxCount = sortedUsers.length > 0 ? sortedUsers[0][1] : 1;
        
        sortedUsers.forEach(([user, count], index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          
          const rankClass = index < 3 ? 'top-3' : '';
          
          item.innerHTML = `
            <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
            <div class="leaderboard-user">${user}</div>
            <div class="leaderboard-count">${count}</div>
            <div class="leaderboard-bar">
              <div class="leaderboard-progress" style="width: ${(count / maxCount) * 100}%"></div>
            </div>
          `;
          
          leaderboard.appendChild(item);
        });
      }

      function goBackToWeeks() {
        document.getElementById('analysisView').style.display = 'none';
        document.getElementById('backToWeeks').style.display = 'none';
        document.getElementById('weekNavigation').style.display = 'block';
      }

      function handleUserFilterChange() {
        const selectedUser = document.getElementById('userFilter').value;
        
        if (!activityData) {
          return;
        }
        
        // Filter data by selected user
        let filteredData = {...activityData};
        
        if (selectedUser) {
          // Filter message counts
          filteredData.message_counts = {
            [selectedUser]: activityData.message_counts[selectedUser] || 0
          };
          
          // Filter hourly activity
          if (activityData.user_hourly_activity && activityData.user_hourly_activity[selectedUser]) {
            filteredData.hourly_activity = activityData.user_hourly_activity[selectedUser];
          } else {
            filteredData.hourly_activity = Array(24).fill(0);
          }
          
          // Filter daily activity
          if (activityData.user_daily_activity && activityData.user_daily_activity[selectedUser]) {
            filteredData.daily_activity = activityData.user_daily_activity[selectedUser];
          } else {
            filteredData.daily_activity = Array(7).fill(0);
          }
        }
        
        // Re-render charts with filtered data
        createActivityCharts(filteredData);
        updateLeaderboard(filteredData.message_counts || {});
      }

      // Initialize permanent Q&A functionality
      function initializePermanentQA() {
        const askBtn = document.getElementById('permanentAskBtn');
        const questionInput = document.getElementById('permanentQuestionInput');
        
        if (askBtn) {
          askBtn.addEventListener('click', () => {
            const question = questionInput.value.trim();
            if (question) {
              askPermanentQuestion(question);
            }
          });
        }
        
        // Allow Enter key to submit question
        if (questionInput) {
          questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              const question = questionInput.value.trim();
              if (question) {
                askPermanentQuestion(question);
              }
            }
          });
        }
      }

      async function askPermanentQuestion(question) {
        const answerDisplay = document.getElementById('permanentAnswerDisplay');
        const answerText = document.getElementById('permanentAnswerText');
        
        // Show loading state
        answerDisplay.style.display = 'block';
        answerText.innerHTML = '<div class="loading-spinner"></div> Analyzing your question...';
        
        try {
          const data = await makeRequest('/ask/', {
            group_name: currentGroup,
            question: question
          });
          
          // Display answer
          answerText.innerHTML = data.answer || 'No answer available.';
        } catch (error) {
          console.error('Error asking question:', error);
          answerText.innerHTML = `Error: ${error.message}`;
        }
      }

      // Topics Functions
      async function analyzeTopics() {
        const startDate = document.getElementById('topicsStartDate').value;
        const endDate = document.getElementById('topicsEndDate').value;
        
        if (!currentGroup) {
          showError('topicsResult', 'Please select a group first.');
          return;
        }
        
        showLoading('topicsResult');
        
        try {
          // This is a placeholder implementation
          // In a real implementation, you would call a topics analysis endpoint
          setTimeout(() => {
            showResult('topicsResult', 'Topic analysis is not yet implemented. This feature will be available soon.');
          }, 1000);
          
          addToHistory('Topic Analysis', { start_date: startDate, end_date: endDate });
        } catch (error) {
          console.error('Topics analysis error:', error);
          showError('topicsResult', 'Failed to analyze topics. Please try again.');
        }
      }

      // History Functions
      function clearHistory() {
        if (confirm('Are you sure you want to clear your analysis history?')) {
          analysisHistory = [];
          localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
          updateHistoryDisplay();
        }
      }

      function viewFullAnalysis(id) {
        // Find the analysis entry
        const entry = analysisHistory.find(item => item.id === id);
        if (!entry) {
          alert('Analysis entry not found.');
          return;
        }
        
        // Show what was searched and the results
        showSearchDetails(entry);
      }

      function showSearchDetails(entry) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('searchDetailsModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'searchDetailsModal';
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh;">
              <div class="modal-header">
                <h3><i class="fas fa-search"></i> Search Details</h3>
                <button class="modal-close" onclick="closeSearchDetails()">&times;</button>
              </div>
              <div class="modal-body" style="max-height: 75vh; overflow-y: auto; padding: 1rem;">
                <div id="searchDetailsContent"></div>
              </div>
              <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSearchDetails()">
                  <i class="fas fa-times"></i> Close
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
        
        // Populate content with search details
        const content = document.getElementById('searchDetailsContent');
        if (content) {
          content.innerHTML = generateSearchDetailsContent(entry);
        }
        
        // Show modal
        modal.style.display = 'flex';
      }

      function closeSearchDetails() {
        const modal = document.getElementById('searchDetailsModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function generateSearchDetailsContent(entry) {
        // Format timestamp
        const timestamp = new Date(entry.timestamp).toLocaleString();
        
        // Format parameters
        let paramsHtml = '';
        if (entry.params) {
          paramsHtml = '<div style="background: var(--bg-light); padding: 1rem; border-radius: 8px; margin: 1rem 0;">' +
            '<h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-cog"></i> Parameters</h4>' +
            '<div style="font-family: monospace; white-space: pre-wrap;">' + 
            JSON.stringify(entry.params, null, 2) + 
            '</div>' +
          '</div>';
        }
        
        // Format results
        let resultsHtml = '';
        if (entry.results) {
          resultsHtml = '<div style="background: var(--bg-light); padding: 1rem; border-radius: 8px; margin: 1rem 0;">' +
            '<h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-poll"></i> Results</h4>' +
            '<div style="font-family: monospace; white-space: pre-wrap;">' + 
            JSON.stringify(entry.results, null, 2) + 
            '</div>' +
          '</div>';
        }
        
        return `
          <div style="padding: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
              <div>
                <h2 style="margin: 0; color: var(--text-dark);">${entry.type}</h2>
                <div style="color: var(--text-muted); font-size: 0.9rem;">Performed on ${timestamp}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600;">${entry.fileInfo?.fileName || 'Unknown Group'}</div>
                <div style="color: var(--text-muted); font-size: 0.9rem;">${entry.fileInfo?.dateRange || 'Full History'}</div>
              </div>
            </div>
            
            ${paramsHtml}
            ${resultsHtml}
          </div>
        `;
      }

      function downloadReport(id) {
        // Find the analysis entry
        const entry = analysisHistory.find(item => item.id === id);
        if (!entry) {
          alert('Analysis entry not found.');
          return;
        }
        
        // Create a downloadable JSON file
        const dataStr = JSON.stringify(entry, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `whatsapp-analysis-${entry.id}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
      }

      function deleteHistoryEntry(id) {
        if (confirm('Are you sure you want to delete this history entry?')) {
          analysisHistory = analysisHistory.filter(item => item.id !== id);
          localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
          updateHistoryDisplay();
        }
      }

      // Q&A Modal Functions
      function showQAModal() {
        const modal = document.getElementById('qaModal');
        if (modal) {
          modal.style.display = 'flex';
        }
      }

      function closeQAModal() {
        const modal = document.getElementById('qaModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function askQuickQuestion(question) {
        const questionInput = document.getElementById('questionInput');
        const askBtn = document.getElementById('askQuestionBtn');
        
        if (questionInput) {
          questionInput.value = question;
        }
        
        if (askBtn) {
          askBtn.click();
        }
      }

      // Enhanced fallback function with hover tooltips
      function createFallbackCharts(data) {
        console.log('🔄 Creating enhanced fallback HTML charts...');
        
        const dailyContainer = document.querySelector('#dailySentimentChart .chart-area');
        const userContainer = document.querySelector('#userSentimentChart .chart-area');
        
        // Force charts container to be visible
        const chartsContainer = document.getElementById('sentimentCharts');
        if (chartsContainer) {
          chartsContainer.style.display = 'flex';
        }
        
        if (dailyContainer) {
          let dailyHtml = '<div style="padding: 20px; background: var(--bg-white); border-radius: 12px;">';
          
          if (data.daily_sentiment && Object.keys(data.daily_sentiment).length > 0) {
            dailyHtml += '<h4 style="color: var(--primary); margin-bottom: 20px;">📅 Daily Sentiment Breakdown</h4>';
            
            Object.keys(data.daily_sentiment)
              .filter(date => date !== 'unknown')
              .sort()
              .forEach(date => {
                const dayData = data.daily_sentiment[date];
                const total = dayData.positive + dayData.neutral + dayData.negative;
                if (total > 0) {
                  const positivePercent = Math.round((dayData.positive / total) * 100);
                  const neutralPercent = Math.round((dayData.neutral / total) * 100);
                  const negativePercent = Math.round((dayData.negative / total) * 100);
                  
                  // Get sample message for hover effect
                  const dayMessages = data.daily_messages ? data.daily_messages[date] || [] : [];
                  const sampleMsg = dayMessages.length > 0 ? dayMessages[0].message?.substring(0, 60) + '...' : '';
                  
                  dailyHtml += `
                    <div class="hover-chart-item" style="
                      margin: 15px 0; padding: 18px; border: 2px solid var(--border); 
                      border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
                      background: linear-gradient(145deg, var(--bg-white), var(--bg-light));
                    " 
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" 
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                    title="📅 ${new Date(date).toLocaleDateString()} - ${total} messages${sampleMsg ? '\n💬 Sample: ' + sampleMsg : ''}">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="color: var(--text-dark);">${new Date(date).toLocaleDateString()}</strong>
                        <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">${total} messages</span>
                      </div>
                      <div style="display: flex; gap: 20px; margin: 12px 0; flex-wrap: wrap;">
                        <span style="color: #10b981; font-weight: 600;">😊 ${dayData.positive} (${positivePercent}%)</span>
                        <span style="color: #6b7280; font-weight: 600;">😐 ${dayData.neutral} (${neutralPercent}%)</span>
                        <span style="color: #ef4444; font-weight: 600;">😞 ${dayData.negative} (${negativePercent}%)</span>
                      </div>
                      <div style="background: var(--bg-light); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="display: flex; height: 100%;">
                          <div style="background: #10b981; width: ${positivePercent}%;"></div>
                          <div style="background: #6b7280; width: ${neutralPercent}%;"></div>
                          <div style="background: #ef4444; width: ${negativePercent}%;"></div>
                        </div>
                      </div>
                    </div>
                  `;
                }
              });
          } else {
            dailyHtml += '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No daily data available</div>';
          }
          
          dailyHtml += '</div>';
          dailyContainer.innerHTML = dailyHtml;
        }
        
        if (userContainer) {
          let userHtml = '<div style="padding: 20px; background: var(--bg-white); border-radius: 12px;">';
          
          const userSentimentData = data.user_sentiment || data.user_sentiments || {};
          if (userSentimentData && Object.keys(userSentimentData).length > 0) {
            userHtml += '<h4 style="color: var(--primary); margin-bottom: 20px;">👥 User Sentiment Breakdown</h4>';
            
            Object.entries(userSentimentData).forEach(([user, sentiments]) => {
              const total = sentiments.positive + sentiments.neutral + sentiments.negative;
              if (total > 0) {
                const positivePercent = Math.round((sentiments.positive / total) * 100);
                const neutralPercent = Math.round((sentiments.neutral / total) * 100);
                const negativePercent = Math.round((sentiments.negative / total) * 100);
                
                // Get sample message for hover effect
                const userMessages = data.user_messages ? data.user_messages[user] || [] : [];
                const sampleMsg = userMessages.length > 0 ? userMessages[0].message?.substring(0, 60) + '...' : '';
                
                userHtml += `
                  <div class="hover-chart-item" style="
                    margin: 15px 0; padding: 18px; border: 2px solid var(--border); 
                    border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
                    background: linear-gradient(145deg, var(--bg-white), var(--bg-light));
                  " 
                  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)';" 
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  title="👤 ${user} - ${total} messages${sampleMsg ? '\n💬 Sample: ' + sampleMsg : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${user.charAt(0).toUpperCase()}</div>
                        <strong style="color: var(--text-dark);">${user}</strong>
                      </div>
                      <span style="background: var(--primary); color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.9em;">${total} messages</span>
                    </div>
                    <div style="display: flex; gap: 20px; margin: 12px 0; flex-wrap: wrap;">
                      <span style="color: #10b981; font-weight: 600;">😊 ${sentiments.positive} (${positivePercent}%)</span>
                      <span style="color: #6b7280; font-weight: 600;">😐 ${sentiments.neutral} (${neutralPercent}%)</span>
                      <span style="color: #ef4444; font-weight: 600;">😞 ${sentiments.negative} (${negativePercent}%)</span>
                    </div>
                    <div style="background: var(--bg-light); height: 10px; border-radius: 5px; overflow: hidden;">
                      <div style="display: flex; height: 100%;">
                        <div style="background: #10b981; width: ${positivePercent}%;"></div>
                        <div style="background: #6b7280; width: ${neutralPercent}%;"></div>
                        <div style="background: #ef4444; width: ${negativePercent}%;"></div>
                      </div>
                    </div>
                  </div>
                `;
              }
            });
          } else {
            userHtml += '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No user data available</div>';
          }
          
          userHtml += '</div>';
          userContainer.innerHTML = userHtml;
        }
        
        console.log('✅ Enhanced fallback charts created with hover functionality');
      }

      // Test function to verify chart creation (can be called from browser console)
      window.testChartCreation = function() {
        console.log('Testing chart creation...');
        debugChartSetup();
        
        if (typeof Chart === 'undefined') {
          console.error('Chart.js is not available!');
          return false;
        }
        
        const testCanvas = document.getElementById('dailyChart');
        if (!testCanvas) {
          console.error('Daily chart canvas not found!');
          return false;
        }
        
        try {
          const ctx = testCanvas.getContext('2d');
          const testChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['Day 1', 'Day 2', 'Day 3'],
              datasets: [{
                label: 'Test Data',
                data: [1, 2, 3],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
          
          console.log('Test chart created successfully:', testChart);
          
          // Clean up test chart after 3 seconds
          setTimeout(() => {
            testChart.destroy();
            console.log('Test chart destroyed');
          }, 3000);
          
          return true;
        } catch (error) {
          console.error('Error creating test chart:', error);
          return false;
        }
      };

      function displaySentimentInsights(data) {
        console.log('🧠 Displaying sentiment insights...', data);
        
        // Create or get insights container
        let insightsContainer = document.getElementById('sentimentInsights');
        if (!insightsContainer) {
          insightsContainer = document.createElement('div');
          insightsContainer.id = 'sentimentInsights';
          insightsContainer.className = 'sentiment-insights';
          insightsContainer.style.cssText = `
            background: var(--bg-white);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
          `;
          
          // Insert after sentiment overview
          const overview = document.getElementById('sentimentOverview');
          if (overview && overview.parentNode) {
            overview.parentNode.insertBefore(insightsContainer, overview.nextSibling);
          }
        }
        
        let insightsHtml = '<div class="insights-section">';
        insightsHtml += '<h3 style="color: var(--text-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">';
        insightsHtml += '<i class="fas fa-lightbulb" style="color: #f59e0b;"></i> 🧠 AI-Powered Insights</h3>';
        
        // Total analyzed count
        const totalAnalyzed = data.total_analyzed || (data.sentiment_breakdown ? Object.values(data.sentiment_breakdown).reduce((a, b) => a + b, 0) : 0);
        if (totalAnalyzed > 0) {
          insightsHtml += `<div class="insight-card" style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px;"><strong>📊 Analysis Summary:</strong> Analyzed ${totalAnalyzed} messages`;
          if (data.analysis_metadata && data.analysis_metadata.processing_time) {
            insightsHtml += ` in ${data.analysis_metadata.processing_time} seconds`;
          }
          insightsHtml += `</div>`;
        }
        
        // Gemini insights
        if (data.gemini_insights) {
          const insights = data.gemini_insights;
          
          if (insights.communication_style) {
            insightsHtml += `<div class="insight-card" style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px;"><strong>💬 Communication Style:</strong> ${insights.communication_style}</div>`;
          }
          
          if (insights.top_emotions && insights.top_emotions.length > 0) {
            insightsHtml += '<div class="insight-card" style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px;"><strong>🎭 Top Emotions:</strong><ul>';
            insights.top_emotions.slice(0, 3).forEach(emotion => {
              insightsHtml += `<li>${emotion}</li>`;
            });
            insightsHtml += '</ul></div>';
          }
          
          if (insights.key_findings && insights.key_findings.length > 0) {
            insightsHtml += '<div class="insight-card" style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px;"><strong>🔍 Key Findings:</strong><ul>';
            insights.key_findings.slice(0, 3).forEach(finding => {
              insightsHtml += `<li>${finding}</li>`;
            });
            insightsHtml += '</ul></div>';
          }
          
          if (insights.mood_patterns && insights.mood_patterns.length > 0) {
            insightsHtml += '<div class="insight-card" style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px;"><strong>📈 Mood Patterns:</strong><ul>';
            insights.mood_patterns.slice(0, 3).forEach(pattern => {
              insightsHtml += `<li>${pattern}</li>`;
            });
            insightsHtml += '</ul></div>';
          }
        }
        
        // Confidence distribution insights
        if (data.confidence_distribution) {
          const conf = data.confidence_distribution;
          const total = conf.high + conf.medium + conf.low;
          if (total > 0) {
            const highPercent = Math.round((conf.high / total) * 100);
            insightsHtml += `<div class="insight-card" style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px;"><strong>🎯 Analysis Confidence:</strong> ${highPercent}% high confidence (${conf.high}/${total} messages)</div>`;
          }
        }
        
        // Negative messages insights
        if (data.negative_messages && data.negative_messages.length > 0) {
          insightsHtml += `<div class="insight-card warning" style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px;"><strong>⚠️ Attention Needed:</strong> ${data.negative_messages.length} messages with negative sentiment detected. <button onclick="showSentimentDetails('negative')" style="margin-left: 10px; padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button></div>`;
        }
        
        insightsHtml += '</div>';
        insightsContainer.innerHTML = insightsHtml;
        insightsContainer.style.display = 'block';
        
        console.log('✅ Sentiment insights displayed successfully');
      }
      
      function showNegativeDetails() {
        if (!sentimentData || !sentimentData.negative_messages) {
          alert('No negative message details available.');
          return;
        }
        
        const modal = document.getElementById('negativeModal');
        const messagesList = document.getElementById('negativeMessagesList');
        
        if (!modal || !messagesList) {
          alert('Modal elements not found.');
          return;
        }
        
        let content = '';
        sentimentData.negative_messages.slice(0, 10).forEach((msg, index) => {
          content += `
            <div class="negative-message-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #fee; border-radius: 8px; background: #fef2f2;">
              <div style="font-weight: bold; color: #dc2626; margin-bottom: 5px;">
                <i class="fas fa-user"></i> ${msg.sender} - ${msg.timestamp}
              </div>
              <div style="margin-bottom: 8px; color: #374151;">${msg.message}</div>
              <div style="font-size: 12px; color: #6b7280;">
                <strong>Reason:</strong> ${msg.reason || 'Negative sentiment detected'}<br>
                <strong>Emotion:</strong> ${msg.emotion || 'Unknown'} | 
                <strong>Confidence:</strong> ${Math.round((msg.confidence || 0) * 100)}%
              </div>
            </div>
          `;
        });
        
        messagesList.innerHTML = content;
        modal.style.display = 'flex';
      }
      
      function closeNegativeModal() {
        const modal = document.getElementById('negativeModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }
      // Force chart display function - can be called manually
      window.forceDisplayCharts = function() {
        console.log('🔧 Manually forcing chart display...');
        
        if (!window.sentimentData) {
          console.error('No sentiment data available!');
          alert('No sentiment data available. Please run sentiment analysis first.');
          return false;
        }
        
        // Force show charts container
        const chartsContainer = document.getElementById('sentimentCharts');
        if (chartsContainer) {
          chartsContainer.style.display = 'flex';
          chartsContainer.style.flexDirection = 'column';
          chartsContainer.style.gap = '2rem';
          chartsContainer.style.visibility = 'visible';
          chartsContainer.style.opacity = '1';
          console.log('✅ Charts container forced to display');
        }
        
        // Force show overview
        const overview = document.getElementById('sentimentOverview');
        if (overview) {
          overview.style.display = 'grid';
          overview.style.visibility = 'visible';
          overview.style.opacity = '1';
        }
        
        // Try Chart.js first
        if (typeof Chart !== 'undefined') {
          console.log('Trying Chart.js charts...');
          createSentimentCharts(window.sentimentData);
        }
        
        // Always create fallback charts as backup
        console.log('Creating fallback charts...');
        setTimeout(() => {
          createFallbackCharts(window.sentimentData);
        }, 1000);
        
        console.log('✅ Chart display forced successfully');
        return true;
      };

      // Gemini-Enhanced Sentiment Analysis Functions
      function createGeminiEnhancedCharts(data) {
        console.log('Creating Gemini-enhanced charts...');
        
        // Create emotion analysis chart if data is available
        if (data.emotion_analysis && Object.keys(data.emotion_analysis).length > 0) {
          createEmotionChart(data.emotion_analysis);
        }
        
        // Create confidence distribution chart if data is available
        if (data.confidence_distribution) {
          createConfidenceChart(data.confidence_distribution);
        }
      }

      function createEmotionChart(emotionData) {
        const emotionCanvas = document.getElementById('emotionChart');
        if (!emotionCanvas || typeof Chart === 'undefined') {
          console.log('Emotion chart canvas not found or Chart.js not available');
          return createEmotionFallback(emotionData);
        }
        
        try {
          const ctx = emotionCanvas.getContext('2d');
          const emotions = Object.keys(emotionData);
          const counts = Object.values(emotionData);
          
          window.emotionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: emotions.map(e => e.charAt(0).toUpperCase() + e.slice(1)),
              datasets: [{
                data: counts,
                backgroundColor: [
                  '#ff6b6b', // anger - red
                  '#4ecdc4', // joy - teal
                  '#45b7d1', // sadness - blue
                  '#f9ca24', // surprise - yellow
                  '#6c5ce7', // fear - purple
                  '#a55eea', // disgust - pink
                  '#95afc0'  // neutral - gray
                ],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    boxWidth: 12,
                    padding: 15
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((context.parsed * 100) / total).toFixed(1);
                      return `${context.label}: ${context.parsed} (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
          
          console.log('✅ Emotion chart created successfully');
        } catch (error) {
          console.error('Error creating emotion chart:', error);
          createEmotionFallback(emotionData);
        }
      }

      function createEmotionFallback(emotionData) {
        const container = document.getElementById('emotionChart');
        if (!container) return;
        
        const total = Object.values(emotionData).reduce((a, b) => a + b, 0);
        const emotionColors = {
          anger: '#ff6b6b',
          joy: '#4ecdc4',
          sadness: '#45b7d1',
          surprise: '#f9ca24',
          fear: '#6c5ce7',
          disgust: '#a55eea',
          neutral: '#95afc0'
        };
        
        let html = '<div class="emotion-bars">';
        Object.entries(emotionData).forEach(([emotion, count]) => {
          const percentage = total > 0 ? ((count * 100) / total).toFixed(1) : 0;
          const color = emotionColors[emotion] || '#95afc0';
          html += `
            <div class="emotion-bar-item">
              <div class="emotion-label">${emotion.charAt(0).toUpperCase() + emotion.slice(1)}</div>
              <div class="emotion-bar" style="background: linear-gradient(90deg, ${color} ${percentage}%, #f0f0f0 ${percentage}%);">
                <span class="emotion-count">${count} (${percentage}%)</span>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        console.log('📊 Emotion fallback chart created');
      }

      function createConfidenceChart(confidenceData) {
        const confidenceCanvas = document.getElementById('confidenceChart');
        if (!confidenceCanvas || typeof Chart === 'undefined') {
          console.log('Confidence chart canvas not found or Chart.js not available');
          return createConfidenceFallback(confidenceData);
        }
        
        try {
          const ctx = confidenceCanvas.getContext('2d');
          const labels = ['High (≥80%)', 'Medium (60-79%)', 'Low (<60%)'];
          const data = [confidenceData.high || 0, confidenceData.medium || 0, confidenceData.low || 0];
          
          window.confidenceChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Messages',
                data: data,
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderColor: ['#059669', '#d97706', '#dc2626'],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((context.parsed.y * 100) / total).toFixed(1) : 0;
                      return `${context.parsed.y} messages (${percentage}%)`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
          
          console.log('✅ Confidence chart created successfully');
        } catch (error) {
          console.error('Error creating confidence chart:', error);
          createConfidenceFallback(confidenceData);
        }
      }

      function createConfidenceFallback(confidenceData) {
        const container = document.getElementById('confidenceChart');
        if (!container) return;
        
        const total = (confidenceData.high || 0) + (confidenceData.medium || 0) + (confidenceData.low || 0);
        const levels = [
          { name: 'High (≥80%)', count: confidenceData.high || 0, color: '#10b981' },
          { name: 'Medium (60-79%)', count: confidenceData.medium || 0, color: '#f59e0b' },
          { name: 'Low (<60%)', count: confidenceData.low || 0, color: '#ef4444' }
        ];
        
        let html = '<div class="confidence-bars">';
        levels.forEach(level => {
          const percentage = total > 0 ? ((level.count * 100) / total).toFixed(1) : 0;
          html += `
            <div class="confidence-bar-item">
              <div class="confidence-label">${level.name}</div>
              <div class="confidence-bar" style="background: linear-gradient(90deg, ${level.color} ${percentage}%, #f0f0f0 ${percentage}%);">
                <span class="confidence-count">${level.count} (${percentage}%)</span>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        console.log('📊 Confidence fallback chart created');
      }

      function displayGeminiInsights(data) {
        if (!data.gemini_insights) {
          console.log('No Gemini insights available');
          return;
        }
        
        console.log('Displaying Gemini insights:', data.gemini_insights);
        
        // Find or create insights container
        let insightsContainer = document.getElementById('geminiInsights');
        if (!insightsContainer) {
          // Create insights section after sentiment charts
          const chartsContainer = document.getElementById('sentimentCharts');
          if (chartsContainer && chartsContainer.parentNode) {
            insightsContainer = document.createElement('div');
            insightsContainer.id = 'geminiInsights';
            insightsContainer.className = 'gemini-insights-section';
            chartsContainer.parentNode.insertBefore(insightsContainer, chartsContainer.nextSibling);
          } else {
            console.error('Could not find sentiment charts container to add insights');
            return;
          }
        }
        
        const insights = data.gemini_insights;
        let html = `
          <div class="insights-header">
            <h3><i class="fas fa-brain"></i> AI-Powered Insights</h3>
            <p class="insights-subtitle">Advanced analysis powered by Google Gemini</p>
          </div>
          <div class="insights-grid">
        `;
        
        // Communication Style
        if (insights.communication_style) {
          html += `
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-comments"></i></div>
              <div class="insight-content">
                <h4>Communication Style</h4>
                <p>${insights.communication_style}</p>
              </div>
            </div>
          `;
        }
        
        // Key Findings
        if (insights.key_findings && insights.key_findings.length > 0) {
          html += `
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-lightbulb"></i></div>
              <div class="insight-content">
                <h4>Key Findings</h4>
                <ul>
                  ${insights.key_findings.map(finding => `<li>${finding}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
        
        // Top Emotions
        if (insights.top_emotions && insights.top_emotions.length > 0) {
          html += `
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-palette"></i></div>
              <div class="insight-content">
                <h4>Dominant Emotions</h4>
                <ul>
                  ${insights.top_emotions.map(emotion => `<li>${emotion}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
        
        // Recommendations
        if (insights.recommendations && insights.recommendations.length > 0) {
          html += `
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-clipboard-list"></i></div>
              <div class="insight-content">
                <h4>Recommendations</h4>
                <ul>
                  ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
        
        // Mood Patterns
        if (insights.mood_patterns && insights.mood_patterns.length > 0) {
          html += `
            <div class="insight-card full-width">
              <div class="insight-icon"><i class="fas fa-chart-line"></i></div>
              <div class="insight-content">
                <h4>Mood Patterns</h4>
                <ul>
                  ${insights.mood_patterns.map(pattern => `<li>${pattern}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        insightsContainer.innerHTML = html;
        insightsContainer.style.display = 'block';
        
        console.log('✅ Gemini insights displayed successfully');
      }

      // Expose functions to global scope for onclick handlers
      window.toggleEventDetails = toggleEventDetails;
      window.selectGroup = selectGroup;
      window.closeGroupSelectionModal = closeGroupSelectionModal;
      window.showSentimentDetails = showSentimentDetails;
      window.closeNegativeModal = closeNegativeModal;
      window.viewFullAnalysis = viewFullAnalysis;
      window.downloadReport = downloadReport;
      window.deleteHistoryEntry = deleteHistoryEntry;
      window.askQuickQuestion = askQuickQuestion;
      window.askPermanentQuestion = askPermanentQuestion;
    })();
  </script>
</body>
</html>    